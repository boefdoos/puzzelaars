<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>De Puzzel - Halloween 2025 Vrijwilligers</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- EmailJS CDN -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDbDBDthwZiqRJNtCjhhfPV28ijoRDjlvU",
            authDomain: "de-puzzel.firebaseapp.com",
            projectId: "de-puzzel",
            storageBucket: "de-puzzel.firebasestorage.app",
            messagingSenderId: "995719179078",
            appId: "1:995719179078:web:5d33b215d15ac57f72d347",
            measurementId: "G-6MTF4QEW3Y"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;

        console.log('‚úÖ Firebase initialized successfully');

        // Initialize app after Firebase is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing app...');
            if (typeof window.initializeApp === 'function') {
                window.initializeApp();
            }
        });
    </script>

    <style>
        :root {
            --primary-color: #16a34a;
            --primary-light: #22c55e;
            --primary-dark: #15803d;
            --secondary-color: #0891b2;
            --accent-color: #ea580c;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --background: #f9fafb;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9f4 0%, #e8f5e8 50%, #dcf4e3 100%);
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 0;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-banner {
            width: 100%;
            height: auto;
            display: block;
            border-radius: var(--border-radius);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 8px;
            box-shadow: var(--shadow);
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 12px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .tab-btn:hover {
            background: rgba(22, 163, 74, 0.1);
            color: var(--primary-color);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(34, 197, 94, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: var(--text-color);
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7) !important;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white !important;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 1001;
            border: none !important;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .success-message {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .error-message {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .loading.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header {
                margin-bottom: 20px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                gap: 3px;
                padding: 6px;
            }
            
            .tab-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .card {
                padding: 15px;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .modal-content {
                padding: 25px;
                margin: 20px;
            }
        }

        /* Priority Functions Styles */
        .priority-section {
            background: linear-gradient(145deg, var(--accent-color), #f97316);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .priority-functions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .priority-function {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .priority-function:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.02);
        }

        /* Schedule Grid Styles */
        .schedule-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .date-section {
            border-left: 4px solid var(--primary-color);
            padding-left: 20px;
            margin-bottom: 30px;
        }

        .date-header {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .function-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .function-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.15);
        }

        .timeslots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .timeslot {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeslot.available {
            border-color: var(--primary-color);
            background: rgba(22, 163, 74, 0.05);
            cursor: pointer;
        }

        .timeslot.available:hover {
            background: rgba(22, 163, 74, 0.15);
            transform: scale(1.03);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.3);
        }

        .timeslot.full {
            background: rgba(239, 68, 68, 0.05);
            border-color: #ef4444;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Admin Panel Styles */
        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .admin-nav .btn {
            font-size: 0.9rem;
            padding: 10px 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'Poppins', sans-serif;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Evaluation Form Styles */
        .rating-group {
            margin: 20px 0;
        }

        .rating-stars {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 10px 0;
            padding: 10px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .star {
            font-size: 2.5rem;
            color: #d1d5db;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            padding: 8px;
            min-width: 50px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            border-radius: 8px;
            background: transparent;
            filter: grayscale(100%);
            opacity: 0.4;
        }

        .star.active {
            color: #fbbf24;
            transform: scale(1.15);
            filter: grayscale(0%);
            opacity: 1;
            background: rgba(251, 191, 36, 0.1);
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        @media (hover: hover) {
            .star:hover {
                color: #fbbf24;
                transform: scale(1.2);
                filter: grayscale(0%);
                opacity: 0.8;
                background: rgba(251, 191, 36, 0.05);
            }
        }
        
        @media (max-width: 768px) {
            .star {
                font-size: 3rem;
                min-width: 55px;
                min-height: 55px;
                padding: 10px;
            }
            
            .rating-stars {
                gap: 15px;
            }
        }

        .textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }

        .textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }
            
            .container {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                padding: 20px;
                border-bottom: 2px solid #16a34a;
            }
            
            .print-header h1 {
                color: #16a34a !important;
                font-size: 2rem !important;
                margin-bottom: 10px;
            }
            
            .print-date-section {
                page-break-inside: avoid;
                margin-bottom: 25px;
                border: 1px solid #e5e7eb;
                padding: 15px;
                border-radius: 8px;
            }
            
            .print-date-header {
                background: #16a34a;
                color: white;
                padding: 10px;
                margin: -15px -15px 15px -15px;
                font-size: 1.2rem;
                font-weight: bold;
            }
            
            .print-timeslot {
                border: 1px solid #d1d5db;
                border-radius: 5px;
                padding: 10px;
                margin-bottom: 10px;
                background: #f9fafb;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .print-function-name {
                font-weight: bold;
                color: #16a34a;
            }
            
            .print-time {
                font-weight: 600;
            }
            
            .print-capacity {
                color: #6b7280;
                font-size: 0.9rem;
            }
        }
        
        @page {
            size: A4 landscape;
            margin: 2cm 2.5cm;
        }
        
        /* Footer Styles */
        .footer {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            text-align: center;
            padding: 30px 20px;
            margin-top: 60px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .footer p {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .footer a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: opacity 0.3s ease;
        }
        
        .footer a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .footer {
                margin-top: 40px;
                padding: 25px 15px;
            }
            
            .footer p {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="Halloween_banner.jpg" alt="Halloween 2025 Banner" class="header-banner">
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('client')">üìÖ Boeken</button>
            <button class="tab-btn" onclick="showTab('evaluation')">‚≠ê Evaluatie</button>
            <button class="tab-btn" onclick="showTab('admin')">üîß Admin</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingMessage" class="loading">
            <h3>‚è≥ Bezig met laden...</h3>
            <p>Data wordt opgehaald van de server</p>
        </div>

        <!-- Client Tab - Booking Section -->
        <div id="clientTab" class="tab-content active">
            <!-- Volunteer Motivation Section -->
            <div id="motivationSection" class="priority-section">
                <h2>üåü Waarom Vrijwilliger Worden?</h2>
                <div id="motivationReasons" class="priority-functions">
                    <div class="priority-function">
                        <h4>üí™ Bouw mee aan de school</h4>
                        <p>Help mee om De Puzzel nog beter te maken voor alle leerlingen.</p>
                    </div>
                    <div class="priority-function">
                        <h4>ü•Ç Gratis drankkaart</h4>
                        <p>Geniet van gratis drankjes tijdens het evenement.</p>
                    </div>
                    <div class="priority-function">
                        <h4>üíö Maak nieuwe vrienden</h4>
                        <p>Leer andere (groot)ouders √©cht kennen.</p>
                    </div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h3>üóìÔ∏è Halloween Planning Rooster</h3>
                    <button class="btn btn-primary" onclick="exportScheduleToPrint()">üñ®Ô∏è Print Planning</button>
                </div>

                <!-- Function Filter -->
                <div style="margin-bottom: 20px;">
                    <label for="functionFilter" class="form-label">Filter op functie:</label>
                    <select id="functionFilter" class="form-input" onchange="filterByFunction(this.value)">
                        <option value="all">Alle functies</option>
                    </select>
                </div>

                <!-- Schedule Content -->
                <div id="scheduleContent"></div>
            </div>
        </div>

        <!-- Evaluation Tab -->
        <div id="evaluationTab" class="tab-content">
            <div class="card">
                <h2>‚≠ê Halloween 2025 Evaluatie</h2>
                <p>Vanaf 18 oktober kun je hier je ervaringen delen als vrijwilliger.</p>
                
                <div id="evaluationForm" style="display: none;">
                    <form id="evalForm">
                        <!-- Dynamic form fields will be generated here -->
                    </form>
                </div>

                <div id="evaluationClosed" style="text-align: center; padding: 40px;">
                    <h3>üìÖ Evaluatie nog niet beschikbaar</h3>
                    <p>Je kunt de evaluatie invullen vanaf 18 oktober 2025, na het Halloween evenement.</p>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content">
            <!-- Admin Login -->
            <div id="adminLogin" class="card">
                <h2>üîê Admin Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Wachtwoord:</label>
                        <input type="password" id="adminPassword" class="form-input" placeholder="Voer admin wachtwoord in" required>
                    </div>
                    <button type="submit" class="btn btn-primary">üîì Inloggen</button>
                </form>
            </div>

            <!-- Admin Panel -->
            <div id="adminPanel" style="display: none;">
                <!-- Admin Navigation -->
                <div class="admin-nav">
                    <button class="btn btn-primary" onclick="showAdminSection('overview')">üìä Overzicht</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('bookings')">üë• Boekingen</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('functions')">üéØ Functies</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('timeslots')">‚è∞ Tijdsloten</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('evaluations')">‚≠ê Evaluaties</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('evaluation-form')">üìù Evaluatie Formulier</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('settings')">‚öôÔ∏è Instellingen</button>
                </div>

                <!-- Admin Content -->
                <div id="adminContent"></div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Tijdslot Boeken</h3>
                <div id="bookingSlotInfo"></div>
            </div>
            <form id="bookingForm">
                <div class="form-group">
                    <label class="form-label">Naam *</label>
                    <input type="text" id="bookingName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">E-mail *</label>
                    <input type="email" id="bookingEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefoon (optioneel)</label>
                    <input type="tel" id="bookingPhone" class="form-input">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ Bevestigen</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bookingModal')" style="flex: 1;">‚ùå Annuleren</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div style="font-size: 3rem; margin-bottom: 15px;">üéâ</div>
                <h3>Boeking Gelukt!</h3>
            </div>
            <div id="successContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn btn-primary" onclick="closeModal('successModal')" style="flex: 1;">üëç Perfect!</button>
            </div>
        </div>
    </div>

    <!-- Function Modal -->
    <div id="functionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="functionModalTitle">‚ûï Nieuwe Functie Toevoegen</h3>
            </div>
            <form id="functionForm">
                <div class="form-group">
                    <label class="form-label">Functie Naam *</label>
                    <input type="text" id="functionName" class="form-input" required placeholder="bijv. Horror House">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschrijving *</label>
                    <textarea id="functionDescription" class="textarea" required placeholder="Korte beschrijving van de functie en taken..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Kleur Selectie</label>
                    <div id="colorPicker" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px;"></div>
                    <input type="hidden" id="functionColorIndex" value="0">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚úì Opslaan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('functionModal')" style="flex: 1;">‚ùå Annuleren</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timeslot Modal -->
    <div id="timeslotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="timeslotModalTitle">‚ûï Nieuw Tijdslot Toevoegen</h3>
            </div>
            <form id="timeslotForm">
                <div class="form-group">
                    <label class="form-label">Functie *</label>
                    <select id="timeslotFunction" class="form-input" required>
                        <option value="">Kies een functie...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Datum *</label>
                    <input type="date" id="timeslotDate" class="form-input" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Start Tijd *</label>
                        <input type="time" id="timeslotStartTime" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eind Tijd *</label>
                        <input type="time" id="timeslotEndTime" class="form-input" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Capaciteit (aantal vrijwilligers) *</label>
                    <input type="number" id="timeslotCapacity" class="form-input" required min="1" max="20" placeholder="bijv. 3">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚úì Opslaan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('timeslotModal')" style="flex: 1;">‚ùå Annuleren</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timeslot Bookings Modal -->
    <div id="timeslotBookingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="bookingsModalTitle">üë• Tijdslot Boekingen</h3>
                <div id="bookingsSlotInfo"></div>
            </div>
            <div id="bookingsList"></div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeModal('timeslotBookingsModal')" style="flex: 1;">‚ùå Sluiten</button>
            </div>
        </div>
    </div>

    <!-- Evaluation Question Modal -->
    <div id="evaluationQuestionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="evaluationQuestionModalTitle">‚ûï Nieuwe Evaluatievraag Toevoegen</h3>
            </div>
            <form id="evaluationQuestionForm">
                <div class="form-group">
                    <label class="form-label">Vraagtype *</label>
                    <select id="questionType" class="form-input" required onchange="updateQuestionForm()">
                        <option value="">Kies een type...</option>
                        <option value="text">Tekstveld (kort)</option>
                        <option value="textarea">Tekstgebied (lang)</option>
                        <option value="select">Keuzelijst</option>
                        <option value="rating">Sterren beoordeling</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Label/Vraag *</label>
                    <input type="text" id="questionLabel" class="form-input" required placeholder="bijv. Wat vond je van de organisatie?">
                </div>
                <div class="form-group">
                    <label class="form-label">Veldnaam *</label>
                    <input type="text" id="questionFieldName" class="form-input" required placeholder="bijv. organizationFeedback">
                    <small style="color: #6b7280; font-size: 0.8rem;">Technische naam voor het veld (geen spaties, alleen letters en underscores)</small>
                </div>
                <div class="form-group" id="questionPlaceholderGroup">
                    <label class="form-label">Placeholder tekst</label>
                    <input type="text" id="questionPlaceholder" class="form-input" placeholder="Hulptekst in het veld...">
                </div>
                <div class="form-group" id="questionOptionsGroup" style="display: none;">
                    <label class="form-label">Opties (JSON formaat)</label>
                    <textarea id="questionOptions" class="textarea" placeholder='[{"value":"yes","label":"Ja"},{"value":"no","label":"Nee"}]'></textarea>
                    <small style="color: #6b7280; font-size: 0.8rem;">Voor functies gebruik: "functions" | Voor custom opties gebruik JSON formaat</small>
                </div>
                <div class="form-group" id="questionRatingGroup" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="form-label">Min waarde</label>
                            <input type="number" id="questionMin" class="form-input" value="1" min="1" max="10">
                        </div>
                        <div>
                            <label class="form-label">Max waarde</label>
                            <input type="number" id="questionMax" class="form-input" value="5" min="1" max="10">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Volgorde</label>
                    <input type="number" id="questionOrder" class="form-input" value="1" min="1">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="questionRequired" style="margin: 0;">
                        <span>Verplicht veld</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚úì Opslaan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('evaluationQuestionModal')" style="flex: 1;">‚ùå Annuleren</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global Variables
        let functions = [];
        let timeSlots = [];
        let bookings = [];
        let evaluations = [];
        let evaluationQuestions = []; // New: store evaluation form structure
        let currentView = 'calendar';
        let selectedFunction = 'all';
        let currentBookingSlot = null;
        let isAdminLoggedIn = false;

        // Email Configuration
        const EMAILJS_CONFIG = {
            serviceId: 'service_4mw5ykn',
            templateId: 'template_fzaajfb',
            publicKey: 'VehBeO9qQGs5Tbvvn'
        };

        // Initialize EmailJS
        emailjs.init(EMAILJS_CONFIG.publicKey);

        // Timeslot Bookings Management
        function showTimeslotBookings(timeslotId) {
            const slot = timeSlots.find(s => s.id === timeslotId);
            if (!slot) return;
            
            const func = functions.find(f => f.id === slot.functionId);
            const color = getFunctionColorById(slot.functionId);
            const slotBookings = bookings.filter(booking => booking.slotId === timeslotId);
            
            // Update modal header with slot info
            const slotInfo = document.getElementById('bookingsSlotInfo');
            slotInfo.innerHTML = `
                <div style="background: ${color.gradient}; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;">${func.name}</h4>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                        <span>üìÖ ${formatDate(slot.date)}</span>
                        <span>üïê ${slot.startTime} - ${slot.endTime}</span>
                        <span>üë• ${slotBookings.length}/${slot.capacity} geboekt</span>
                    </div>
                </div>
            `;
            
            // Show bookings list
            const bookingsList = document.getElementById('bookingsList');
            
            if (slotBookings.length === 0) {
                bookingsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üìù</div>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">Geen boekingen gevonden</div>
                        <div style="font-size: 0.9rem;">Dit tijdslot heeft nog geen vrijwilligers</div>
                    </div>
                `;
            } else {
                let html = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--text-color);">Geboekte Vrijwilligers (${slotBookings.length})</h4>
                        <div style="display: grid; gap: 10px;">
                `;
                
                slotBookings.forEach((booking, index) => {
                    const bookingDate = new Date(booking.bookingDate).toLocaleDateString('nl-NL');
                    html += `
                        <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-color); margin-bottom: 5px;">üë§ ${booking.name}</div>
                                <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 3px;">
                                    üìß <a href="mailto:${booking.email}" style="color: var(--primary-color);">${booking.email}</a>
                                </div>
                                ${booking.phone ? `<div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 3px;">üìû <a href="tel:${booking.phone}" style="color: var(--primary-color);">${booking.phone}</a></div>` : ''}
                                <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 5px;">
                                    Geboekt op: ${bookingDate}
                                </div>
                            </div>
                            <button class="btn delete-booking-btn" style="padding: 8px 12px; background: #dc2626; color: white; font-size: 0.8rem; margin-left: 15px;" 
                                    data-booking-id="${booking.id || index}" data-timeslot-id="${timeslotId}" data-booking-email="${booking.email}">
                                üóëÔ∏è Verwijder
                            </button>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                bookingsList.innerHTML = html;
                
                // Add event listeners for delete buttons
                document.querySelectorAll('.delete-booking-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const bookingId = this.getAttribute('data-booking-id');
                        const timeslotId = this.getAttribute('data-timeslot-id');
                        const bookingEmail = this.getAttribute('data-booking-email');
                        deleteBooking(bookingId, timeslotId, bookingEmail);
                    });
                });
            }
            
            openModal('timeslotBookingsModal');
        }
        
        async function deleteBooking(bookingId, timeslotId, bookingEmail = null) {
            // Find booking by ID first, then by email as fallback
            let booking = bookings.find(b => b.id === bookingId);
            if (!booking && bookingEmail) {
                booking = bookings.find(b => b.email === bookingEmail && b.slotId === timeslotId);
            }
            
            const slot = timeSlots.find(s => s.id === timeslotId);
            
            if (!booking || !slot) {
                showError('Boeking of tijdslot niet gevonden');
                return;
            }
            
            if (!confirm(`Weet je zeker dat je de boeking van "${booking.name}" wilt verwijderen?\n\nDit kan niet ongedaan gemaakt worden.`)) {
                return;
            }
            
            try {
                // Find the Firebase document by searching through all bookings documents
                const bookingsSnapshot = await window.getDocs(window.collection(window.db, 'bookings'));
                let bookingDocId = null;
                
                bookingsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.email === booking.email && data.slotId === timeslotId) {
                        bookingDocId = doc.id;
                    }
                });
                
                // Delete booking from Firebase
                if (bookingDocId) {
                    await window.deleteDoc(window.doc(window.db, 'bookings', bookingDocId));
                }
                
                // Find the timeslot Firebase document
                const timeSlotsSnapshot = await window.getDocs(window.collection(window.db, 'timeSlots'));
                let slotDocId = null;
                
                timeSlotsSnapshot.docs.forEach(doc => {
                    if (doc.data().id === timeslotId || doc.id === timeslotId) {
                        slotDocId = doc.id;
                    }
                });
                
                // Update timeslot in Firebase
                if (slotDocId) {
                    const updatedVolunteers = (slot.volunteers || []).filter(v => v.email !== booking.email);
                    const slotRef = window.doc(window.db, 'timeSlots', slotDocId);
                    await window.updateDoc(slotRef, {
                        booked: Math.max(0, slot.booked - 1),
                        volunteers: updatedVolunteers
                    });
                }
                
                // Update local data
                const bookingIndex = bookings.findIndex(b => b.email === booking.email && b.slotId === timeslotId);
                if (bookingIndex !== -1) {
                    bookings.splice(bookingIndex, 1);
                }
                
                slot.booked = Math.max(0, slot.booked - 1);
                if (slot.volunteers) {
                    slot.volunteers = slot.volunteers.filter(v => v.email !== booking.email);
                }
                
                showSuccess(`‚úÖ Boeking van "${booking.name}" succesvol verwijderd`);
                
                // Refresh views
                renderSchedule();
                
                // If we're in admin mode, refresh admin view
                if (isAdminLoggedIn) {
                    // Refresh the bookings modal
                    showTimeslotBookings(timeslotId);
                    
                    // Also refresh admin overview if it's currently shown
                    const activeAdminBtn = document.querySelector('.admin-nav .btn-primary');
                    if (activeAdminBtn && activeAdminBtn.textContent.includes('Overzicht')) {
                        showAdminSection('overview');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error deleting booking:', error);
                showError('Fout bij het verwijderen van de boeking. Probeer opnieuw.');
            }
        }

        // Admin Delete Booking Function (from bookings overview)
        async function deleteBookingFromAdmin(bookingId, timeslotId, bookingEmail, bookingName) {
            // Find booking by ID first, then by email as fallback
            let booking = bookings.find(b => b.id === bookingId);
            if (!booking && bookingEmail) {
                booking = bookings.find(b => b.email === bookingEmail && b.slotId === timeslotId);
            }
            
            const slot = timeSlots.find(s => s.id === timeslotId);
            
            if (!booking || !slot) {
                showError('Boeking of tijdslot niet gevonden');
                return;
            }
            
            if (!confirm(`Weet je zeker dat je de boeking van "${bookingName || booking.name}" wilt verwijderen?\n\nDit kan niet ongedaan gemaakt worden.`)) {
                return;
            }
            
            try {
                // Find the Firebase document by searching through all bookings documents
                const bookingsSnapshot = await window.getDocs(window.collection(window.db, 'bookings'));
                let bookingDocId = null;
                
                bookingsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.email === booking.email && data.slotId === timeslotId) {
                        bookingDocId = doc.id;
                    }
                });
                
                // Delete booking from Firebase
                if (bookingDocId) {
                    await window.deleteDoc(window.doc(window.db, 'bookings', bookingDocId));
                }
                
                // Find the timeslot Firebase document
                const timeSlotsSnapshot = await window.getDocs(window.collection(window.db, 'timeSlots'));
                let slotDocId = null;
                
                timeSlotsSnapshot.docs.forEach(doc => {
                    if (doc.data().id === timeslotId || doc.id === timeslotId) {
                        slotDocId = doc.id;
                    }
                });
                
                // Update timeslot in Firebase
                if (slotDocId) {
                    const updatedVolunteers = (slot.volunteers || []).filter(v => v.email !== booking.email);
                    const slotRef = window.doc(window.db, 'timeSlots', slotDocId);
                    await window.updateDoc(slotRef, {
                        booked: Math.max(0, slot.booked - 1),
                        volunteers: updatedVolunteers
                    });
                }
                
                // Update local data
                const bookingIndex = bookings.findIndex(b => b.email === booking.email && b.slotId === timeslotId);
                if (bookingIndex !== -1) {
                    bookings.splice(bookingIndex, 1);
                }
                
                slot.booked = Math.max(0, slot.booked - 1);
                if (slot.volunteers) {
                    slot.volunteers = slot.volunteers.filter(v => v.email !== booking.email);
                }
                
                showSuccess(`‚úÖ Boeking van "${bookingName || booking.name}" succesvol verwijderd`);
                
                // Refresh views
                renderSchedule();
                showAdminSection('bookings'); // Refresh the bookings list
                
            } catch (error) {
                console.error('‚ùå Error deleting booking:', error);
                showError('Fout bij het verwijderen van de boeking. Probeer opnieuw.');
            }
        }

        // Enhanced color scheme for functions - more distinct and vibrant with higher opacity
        const functionColors = [
            { primary: '#16a34a', bg: 'rgba(22, 163, 74, 0.25)', gradient: 'linear-gradient(135deg, #16a34a, #22c55e)', name: 'Groen' }, // Horror/Scare
            { primary: '#dc2626', bg: 'rgba(220, 38, 38, 0.25)', gradient: 'linear-gradient(135deg, #dc2626, #ef4444)', name: 'Rood' }, // Urgent/Emergency
            { primary: '#7c3aed', bg: 'rgba(124, 58, 237, 0.25)', gradient: 'linear-gradient(135deg, #7c3aed, #8b5cf6)', name: 'Paars' }, // Management
            { primary: '#ea580c', bg: 'rgba(234, 88, 12, 0.25)', gradient: 'linear-gradient(135deg, #ea580c, #f97316)', name: 'Oranje' }, // Service
            { primary: '#0891b2', bg: 'rgba(8, 145, 178, 0.25)', gradient: 'linear-gradient(135deg, #0891b2, #06b6d4)', name: 'Cyaan' }, // Support
            { primary: '#059669', bg: 'rgba(5, 150, 105, 0.25)', gradient: 'linear-gradient(135deg, #059669, #10b981)', name: 'Smaragd' }, // Cleanup
            { primary: '#be185d', bg: 'rgba(190, 24, 93, 0.25)', gradient: 'linear-gradient(135deg, #be185d, #ec4899)', name: 'Roze' }, // Special
            { primary: '#1e40af', bg: 'rgba(30, 64, 175, 0.25)', gradient: 'linear-gradient(135deg, #1e40af, #3b82f6)', name: 'Blauw' }, // Tech
            { primary: '#92400e', bg: 'rgba(146, 64, 14, 0.25)', gradient: 'linear-gradient(135deg, #92400e, #d97706)', name: 'Bruin' }, // Setup
            { primary: '#7e22ce', bg: 'rgba(126, 34, 206, 0.25)', gradient: 'linear-gradient(135deg, #7e22ce, #a855f7)', name: 'Violet' } // Creative
        ];

        // Utility Functions
        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success-message';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showLoading(show = true) {
            const loading = document.getElementById('loadingMessage');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        function getFunctionColor(index) {
            return functionColors[index % functionColors.length];
        }

        function getFunctionColorById(functionId) {
            const func = functions.find(f => f.id === functionId);
            if (func && func.colorIndex !== undefined) {
                return getFunctionColor(func.colorIndex);
            }
            // Fallback to index-based coloring for legacy functions
            const index = functions.findIndex(f => f.id === functionId);
            return getFunctionColor(index);
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('nl-NL', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Hide all tab buttons active state
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Special handling for evaluation tab
            if (tabName === 'evaluation') {
                checkEvaluationAvailability();
            }
        }

        // Modal Management - improved event handling
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            
            // Ensure modal content clicks don't bubble
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'bookingModal') {
                document.getElementById('bookingForm').reset();
                currentBookingSlot = null;
            }
            if (modalId === 'functionModal') {
                document.getElementById('functionForm').reset();
                currentEditingFunction = null;
            }
            if (modalId === 'timeslotModal') {
                document.getElementById('timeslotForm').reset();
                currentEditingTimeslot = null;
            }
        }

        // Initialize App
        window.initializeApp = async function() {
            console.log('üöÄ Initializing Halloween 2025 Volunteer Planning App...');
            
            try {
                showLoading(true);
                
                // Load data from Firebase
                await loadDataFromFirebase();
                
                // Initialize UI
                initializeUI();
                
                // Setup event listeners
                setupEventListeners();
                
                showLoading(false);
                console.log('‚úÖ App initialized successfully!');
                
                // Show message if no data is available
                if (functions.length === 0) {
                    showError('Geen functies gevonden. Gebruik admin panel om functies toe te voegen.');
                }
                if (timeSlots.length === 0) {
                    console.log('‚ÑπÔ∏è Geen tijdsloten gevonden. Deze kunnen via admin panel toegevoegd worden.');
                }
                
            } catch (error) {
                console.error('‚ùå Error initializing app:', error);
                showError('Fout bij het verbinden met Firebase. Controleer de verbinding.');
                showLoading(false);
                
                // Initialize UI anyway for admin access
                initializeUI();
                setupEventListeners();
            }
        };

        // Load Data from Firebase
        async function loadDataFromFirebase() {
            console.log('üìä Loading data from Firebase...');
            
            try {
                // Load functions
                const functionsSnapshot = await window.getDocs(window.collection(window.db, 'functions'));
                functions = functionsSnapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    id: doc.data().id || doc.id,
                    ...doc.data()
                }));

                // Load time slots
                const timeSlotsSnapshot = await window.getDocs(window.collection(window.db, 'timeSlots'));
                timeSlots = timeSlotsSnapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    id: doc.data().id || doc.id,
                    ...doc.data()
                }));

                // Load bookings
                const bookingsSnapshot = await window.getDocs(window.collection(window.db, 'bookings'));
                bookings = bookingsSnapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    id: doc.data().id || doc.id,
                    ...doc.data()
                }));

                // Load evaluations
                const evaluationsSnapshot = await window.getDocs(window.collection(window.db, 'evaluations'));
                evaluations = evaluationsSnapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    id: doc.data().id || doc.id,
                    ...doc.data()
                }));

                // Load evaluation questions
                const evaluationQuestionsSnapshot = await window.getDocs(window.collection(window.db, 'evaluationQuestions'));
                evaluationQuestions = evaluationQuestionsSnapshot.docs.map(doc => ({
                    firebaseId: doc.id,
                    id: doc.data().id || doc.id,
                    ...doc.data()
                }));
                
                // Sort evaluation questions by order
                evaluationQuestions.sort((a, b) => (a.order || 0) - (b.order || 0));

                console.log('‚úÖ Data loaded:', { functions: functions.length, timeSlots: timeSlots.length, bookings: bookings.length, evaluations: evaluations.length, evaluationQuestions: evaluationQuestions.length });
                
                // Ensure all functions have colorIndex for legacy compatibility
                functions.forEach((func, index) => {
                    if (func.colorIndex === undefined) {
                        func.colorIndex = index % functionColors.length;
                    }
                });
                
                // Show info message if database is empty
                if (functions.length === 0 && timeSlots.length === 0 && bookings.length === 0) {
                    console.log('üì∞ Database is empty - ready for setup via admin panel');
                } else {
                    console.log(`üìà Found existing data: ${functions.length} functions, ${timeSlots.length} slots, ${bookings.length} bookings`);
                }
                
            } catch (error) {
                console.error('‚ùå Error loading data from Firebase:', error);
                throw error;
            }
        }

        // Generate Halloween Sample Data
        async function generateHalloweenData() {
            console.log('üéÉ Generating Halloween 2025 sample data...');
            
            // Halloween Functions with colorIndex
            const halloweenFunctions = [
                {
                    id: 'horror-house',
                    name: 'Horror House',
                    description: 'Bezoekers door het griezelige horror huis begeleiden en voor sfeer zorgen',
                    colorIndex: 0
                },
                {
                    id: 'scare-actors',
                    name: 'Scare Actors',
                    description: 'Bezoekers laten schrikken in verschillende themadecors',
                    colorIndex: 1
                },
                {
                    id: 'ticket-verkoop',
                    name: 'Ticket Verkoop',
                    description: 'Tickets verkopen en bezoekers verwelkomen bij de ingang',
                    colorIndex: 2
                },
                {
                    id: 'catering',
                    name: 'Catering',
                    description: 'Drankjes en snacks verkopen aan bezoekers',
                    colorIndex: 3
                },
                {
                    id: 'decoratie',
                    name: 'Decoratie',
                    description: 'Halloween decoraties ophangen en sfeer cre√´ren',
                    colorIndex: 4
                },
                {
                    id: 'opruimen',
                    name: 'Opruimen',
                    description: 'Na het evenement alles netjes opruimen en inpakken',
                    colorIndex: 5
                }
            ];

            // Halloween Time Slots
            const halloweenTimeSlots = [
                // Voorbereiding - 16 oktober
                { functionId: 'decoratie', date: '2025-10-16', startTime: '14:00', endTime: '17:00', capacity: 4 },
                { functionId: 'decoratie', date: '2025-10-16', startTime: '17:00', endTime: '20:00', capacity: 3 },
                
                // Halloween Day - 17 oktober
                { functionId: 'ticket-verkoop', date: '2025-10-17', startTime: '18:00', endTime: '20:00', capacity: 2 },
                { functionId: 'ticket-verkoop', date: '2025-10-17', startTime: '20:00', endTime: '22:00', capacity: 2 },
                { functionId: 'horror-house', date: '2025-10-17', startTime: '18:30', endTime: '20:30', capacity: 3 },
                { functionId: 'horror-house', date: '2025-10-17', startTime: '20:30', endTime: '22:30', capacity: 3 },
                { functionId: 'scare-actors', date: '2025-10-17', startTime: '18:30', endTime: '20:30', capacity: 5 },
                { functionId: 'scare-actors', date: '2025-10-17', startTime: '20:30', endTime: '22:30', capacity: 5 },
                { functionId: 'catering', date: '2025-10-17', startTime: '18:00', endTime: '21:00', capacity: 3 },
                { functionId: 'catering', date: '2025-10-17', startTime: '21:00', endTime: '23:00', capacity: 2 },
                
                // Opruiming - 18 oktober
                { functionId: 'opruimen', date: '2025-10-18', startTime: '10:00', endTime: '13:00', capacity: 6 },
                { functionId: 'opruimen', date: '2025-10-18', startTime: '13:00', endTime: '16:00', capacity: 4 }
            ];

            // Only generate if user confirms
            if (!confirm('Wil je Halloween 2025 voorbeelddata genereren? Dit voegt functies en tijdsloten toe aan Firebase.')) {
                return;
            }

            try {
                // Save functions to Firebase
                for (const func of halloweenFunctions) {
                    const docRef = await window.addDoc(window.collection(window.db, 'functions'), func);
                    func.firebaseId = docRef.id;
                    functions.push(func); // Add to local array immediately
                }

                // Update time slots to use generated function IDs
                const halloweenTimeSlots = [
                    // Voorbereiding - 16 oktober
                    { functionId: functions.find(f => f.name === 'Decoratie')?.id || 'decoratie', date: '2025-10-16', startTime: '14:00', endTime: '17:00', capacity: 4 },
                    { functionId: functions.find(f => f.name === 'Decoratie')?.id || 'decoratie', date: '2025-10-16', startTime: '17:00', endTime: '20:00', capacity: 3 },
                    
                    // Halloween Day - 17 oktober
                    { functionId: functions.find(f => f.name === 'Ticket Verkoop')?.id || 'ticket-verkoop', date: '2025-10-17', startTime: '18:00', endTime: '20:00', capacity: 2 },
                    { functionId: functions.find(f => f.name === 'Ticket Verkoop')?.id || 'ticket-verkoop', date: '2025-10-17', startTime: '20:00', endTime: '22:00', capacity: 2 },
                    { functionId: functions.find(f => f.name === 'Horror House')?.id || 'horror-house', date: '2025-10-17', startTime: '18:30', endTime: '20:30', capacity: 3 },
                    { functionId: functions.find(f => f.name === 'Horror House')?.id || 'horror-house', date: '2025-10-17', startTime: '20:30', endTime: '22:30', capacity: 3 },
                    { functionId: functions.find(f => f.name === 'Scare Actors')?.id || 'scare-actors', date: '2025-10-17', startTime: '18:30', endTime: '20:30', capacity: 5 },
                    { functionId: functions.find(f => f.name === 'Scare Actors')?.id || 'scare-actors', date: '2025-10-17', startTime: '20:30', endTime: '22:30', capacity: 5 },
                    { functionId: functions.find(f => f.name === 'Catering')?.id || 'catering', date: '2025-10-17', startTime: '18:00', endTime: '21:00', capacity: 3 },
                    { functionId: functions.find(f => f.name === 'Catering')?.id || 'catering', date: '2025-10-17', startTime: '21:00', endTime: '23:00', capacity: 2 },
                    
                    // Opruiming - 18 oktober
                    { functionId: functions.find(f => f.name === 'Opruimen')?.id || 'opruimen', date: '2025-10-18', startTime: '10:00', endTime: '13:00', capacity: 6 },
                    { functionId: functions.find(f => f.name === 'Opruimen')?.id || 'opruimen', date: '2025-10-18', startTime: '13:00', endTime: '16:00', capacity: 4 }
                ];

                // Save time slots to Firebase
                for (const slot of halloweenTimeSlots) {
                    const slotData = {
                        ...slot,
                        id: generateId(),
                        booked: 0, // Start with empty slots
                        volunteers: []
                    };
                    const docRef = await window.addDoc(window.collection(window.db, 'timeSlots'), slotData);
                    slotData.firebaseId = docRef.id;
                    timeSlots.push(slotData); // Add to local array immediately
                }

                // Generate default evaluation questions if none exist
                if (evaluationQuestions.length === 0) {
                    const defaultQuestions = [
                        {
                            id: generateId(),
                            type: 'text',
                            fieldName: 'evalName',
                            label: 'Je naam (optioneel):',
                            placeholder: 'Naam',
                            required: false,
                            order: 1
                        },
                        {
                            id: generateId(),
                            type: 'select',
                            fieldName: 'evalFunction',
                            label: 'Voor welke functie was je vrijwilliger?',
                            options: 'functions', // Special value to load from functions
                            required: true,
                            order: 2
                        },
                        {
                            id: generateId(),
                            type: 'rating',
                            fieldName: 'organizationRating',
                            label: 'Hoe beoordeel je de organisatie? (1-5 sterren)',
                            min: 1,
                            max: 5,
                            required: true,
                            order: 3
                        },
                        {
                            id: generateId(),
                            type: 'textarea',
                            fieldName: 'evalPositive',
                            label: 'Wat ging er goed?',
                            placeholder: 'Positieve punten...',
                            required: false,
                            order: 4
                        },
                        {
                            id: generateId(),
                            type: 'textarea',
                            fieldName: 'evalImprovements',
                            label: 'Wat kan er beter?',
                            placeholder: 'Verbeterpunten...',
                            required: false,
                            order: 5
                        },
                        {
                            id: generateId(),
                            type: 'select',
                            fieldName: 'evalVolunteerAgain',
                            label: 'Wil je volgend jaar weer vrijwilliger zijn?',
                            options: [{
                                value: '',
                                label: 'Maak een keuze...'
                            }, {
                                value: 'yes',
                                label: 'Ja, zeker!'
                            }, {
                                value: 'maybe',
                                label: 'Misschien'
                            }, {
                                value: 'no',
                                label: 'Nee'
                            }],
                            required: true,
                            order: 6
                        },
                        {
                            id: generateId(),
                            type: 'textarea',
                            fieldName: 'evalComments',
                            label: 'Overige opmerkingen:',
                            placeholder: 'Opmerkingen...',
                            required: false,
                            order: 7
                        }
                    ];

                    // Save default evaluation questions to Firebase
                    for (const question of defaultQuestions) {
                        const docRef = await window.addDoc(window.collection(window.db, 'evaluationQuestions'), question);
                        question.firebaseId = docRef.id;
                        evaluationQuestions.push(question);
                    }
                }

                console.log('‚úÖ Halloween sample data generated successfully!');
                showSuccess(`üéÉ ${halloweenFunctions.length} functies en ${halloweenTimeSlots.length} tijdsloten toegevoegd!`);
                
                // Refresh UI
                initializeUI();

            } catch (error) {
                console.error('‚ùå Error generating sample data:', error);
                showError('Fout bij het genereren van voorbeelddata: ' + error.message);
            }
        }

        // Initialize UI
        function initializeUI() {
            console.log('üé® Initializing UI...');
            
            // Populate function filter
            const functionFilter = document.getElementById('functionFilter');
            functionFilter.innerHTML = '<option value="all">Alle functies</option>';
            functions.forEach(func => {
                const option = document.createElement('option');
                option.value = func.id;
                option.textContent = func.name;
                functionFilter.appendChild(option);
            });

            // Render initial view
            renderSchedule();
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Booking form
            document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);
            
            // Evaluation form
            document.getElementById('evalForm').addEventListener('submit', handleEvaluationSubmit);
            
            // Admin login
            document.getElementById('loginForm').addEventListener('submit', handleAdminLogin);
            
            // Function form
            document.getElementById('functionForm').addEventListener('submit', handleFunctionSubmit);
            
            // Timeslot form
            document.getElementById('timeslotForm').addEventListener('submit', handleTimeslotSubmit);
            
            // Evaluation question form
            document.getElementById('evaluationQuestionForm').addEventListener('submit', handleEvaluationQuestionSubmit);
            
            // Modal close on outside click - prevent event bubbling issues
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
                
                // Prevent modal content clicks from bubbling to modal wrapper
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
            });
        }

        // View Management - removed toggle, only calendar view

        function filterByFunction(functionId) {
            selectedFunction = functionId;
            renderSchedule();
        }

        // Schedule Rendering - only calendar view
        function renderSchedule() {
            const content = document.getElementById('scheduleContent');
            renderCalendarSchedule(content);
        }

        // Overview function removed - only calendar view now

        function renderCalendarSchedule(container) {
            // Similar to overview but more compact, time-focused layout
            const slotsByDate = {};
            timeSlots.forEach(slot => {
                if (selectedFunction !== 'all' && slot.functionId !== selectedFunction) return;
                
                if (!slotsByDate[slot.date]) {
                    slotsByDate[slot.date] = [];
                }
                slotsByDate[slot.date].push(slot);
            });

            let html = '<div style="display: grid; gap: 25px;">';
            
            Object.keys(slotsByDate).sort().forEach(date => {
                const dateSlots = slotsByDate[date];
                
                html += `
                    <div class="card" style="padding: 20px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">${formatDate(date)}</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                `;
                
                dateSlots.sort((a, b) => a.startTime.localeCompare(b.startTime)).forEach(slot => {
                    const func = functions.find(f => f.id === slot.functionId);
                    const color = getFunctionColorById(slot.functionId);
                    const available = slot.capacity - slot.booked;
                    const isAvailable = available > 0;
                    
                    html += `
                    <div class="timeslot ${isAvailable ? 'available' : 'full'}" 
                    style="padding: 15px; border: 3px solid ${color.primary}; background: ${color.bg}; position: relative; overflow: hidden;"
                    ${isAvailable ? `data-slot-id="${slot.id}"` : ''}>
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: ${color.gradient}; opacity: 0.15; z-index: 1;"></div>
                    <div style="position: relative; z-index: 2;">
                        <div style="font-weight: 700; color: ${color.primary}; margin-bottom: 8px; font-size: 1rem;">${func.name}</div>
                        <div style="font-size: 0.9rem; margin-bottom: 8px; font-weight: 600;">${slot.startTime} - ${slot.endTime}</div>
                        <div style="font-size: 0.8rem; color: #374151; font-weight: 500;">
                        ${isAvailable ? `${available} van ${slot.capacity} vrij` : `Vol (${slot.capacity} plekken)`}
                        </div>
                    </div>
                    </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Add event listeners for timeslot clicks
            document.querySelectorAll('[data-slot-id]').forEach(slot => {
                slot.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const slotId = this.getAttribute('data-slot-id');
                    if (slotId) {
                        openBookingModal(slotId);
                    }
                });
            });
        }

        // Motivation section is now static in HTML

        // Booking Modal
        function openBookingModal(slotId) {
            const slot = timeSlots.find(s => s.id === slotId);
            if (!slot) return;

            const func = functions.find(f => f.id === slot.functionId);
            const color = getFunctionColorById(slot.functionId);
            
            currentBookingSlot = slot;
            
            const slotInfo = document.getElementById('bookingSlotInfo');
            slotInfo.innerHTML = `
                <div style="background: ${color.gradient}; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;">${func.name}</h4>
                    <p style="margin-bottom: 8px; font-size: 0.9rem;">${func.description}</p>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                        <span>üìÖ ${formatDate(slot.date)}</span>
                        <span>üïê ${slot.startTime} - ${slot.endTime}</span>
                    </div>
                </div>
            `;
            
            openModal('bookingModal');
        }

        // Handle Booking Submit
        async function handleBookingSubmit(e) {
            e.preventDefault();
            
            if (!currentBookingSlot) return;
            
            // Get submit button and disable it immediately
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '‚è≥ Bezig met boeken...';
            submitButton.style.opacity = '0.6';
            submitButton.style.cursor = 'not-allowed';
            
            const email = document.getElementById('bookingEmail').value;
            
            // Check if user already has a booking for this exact timeslot
            const existingBooking = bookings.find(b => 
                b.email === email && 
                b.slotId === currentBookingSlot.id
            );
            
            if (existingBooking) {
                showError('Je hebt dit tijdslot al geboekt. Controleer je bevestigingsmail of kies een ander tijdslot.');
                // Re-enable button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                submitButton.style.opacity = '1';
                submitButton.style.cursor = 'pointer';
                return;
            }
            
            const formData = {
                name: document.getElementById('bookingName').value,
                email: email,
                phone: document.getElementById('bookingPhone').value || null,
                slotId: currentBookingSlot.id,
                functionId: currentBookingSlot.functionId,
                date: currentBookingSlot.date,
                startTime: currentBookingSlot.startTime,
                endTime: currentBookingSlot.endTime,
                bookingDate: new Date().toISOString()
            };

            try {
                // Save booking to Firebase
                await window.addDoc(window.collection(window.db, 'bookings'), formData);
                
                // Try to update time slot in Firebase
                let firebaseSlotId = currentBookingSlot.firebaseId;
                
                // If no direct firebaseId, search for it
                if (!firebaseSlotId) {
                    const timeSlotsSnapshot = await window.getDocs(window.collection(window.db, 'timeSlots'));
                    
                    timeSlotsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        // Match by all slot properties to find the correct document
                        if (data.functionId === currentBookingSlot.functionId &&
                            data.date === currentBookingSlot.date &&
                            data.startTime === currentBookingSlot.startTime &&
                            data.endTime === currentBookingSlot.endTime &&
                            data.capacity === currentBookingSlot.capacity) {
                            firebaseSlotId = doc.id;
                        }
                    });
                }
                
                // Update time slot if Firebase ID found
                if (firebaseSlotId) {
                    try {
                        const slotRef = window.doc(window.db, 'timeSlots', firebaseSlotId);
                        await window.updateDoc(slotRef, {
                            booked: currentBookingSlot.booked + 1,
                            volunteers: [...(currentBookingSlot.volunteers || []), {
                                name: formData.name,
                                email: formData.email,
                                phone: formData.phone
                            }]
                        });
                        console.log('‚úÖ Timeslot updated in Firebase with ID:', firebaseSlotId);
                    } catch (updateError) {
                        console.error('‚ùå Error updating timeslot in Firebase:', updateError);
                        // Continue with local data update even if Firebase fails
                    }
                } else {
                    console.warn('‚ö†Ô∏è Firebase timeslot not found, updating local data only');
                    console.log('Looking for slot:', {
                        functionId: currentBookingSlot.functionId,
                        date: currentBookingSlot.date,
                        startTime: currentBookingSlot.startTime,
                        endTime: currentBookingSlot.endTime,
                        capacity: currentBookingSlot.capacity
                    });
                }

                // Send confirmation email
                await sendConfirmationEmail(formData);
                
                // Update local data
                currentBookingSlot.booked += 1;
                if (!currentBookingSlot.volunteers) currentBookingSlot.volunteers = [];
                currentBookingSlot.volunteers.push({
                    name: formData.name,
                    email: formData.email,
                    phone: formData.phone
                });
                bookings.push(formData);

                closeModal('bookingModal');
                showBookingSuccess(formData);
                renderSchedule();
                
                // Re-enable button (for next booking)
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                submitButton.style.opacity = '1';
                submitButton.style.cursor = 'pointer';
                
            } catch (error) {
                console.error('‚ùå Error saving booking:', error);
                showError('Fout bij het opslaan van de boeking');
                
                // Re-enable button on error
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                submitButton.style.opacity = '1';
                submitButton.style.cursor = 'pointer';
            }
        }

        function showBookingSuccess(booking) {
            const func = functions.find(f => f.id === booking.functionId);
            const successContent = document.getElementById('successContent');
            
            successContent.innerHTML = `
                <div style="text-align: center; margin: 20px 0;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Je bent ingeschreven voor:</h4>
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color);">
                        <p><strong>Functie:</strong> ${func.name}</p>
                        <p><strong>Datum:</strong> ${formatDate(booking.date)}</p>
                        <p><strong>Tijd:</strong> ${booking.startTime} - ${booking.endTime}</p>
                        <p><strong>Naam:</strong> ${booking.name}</p>
                    </div>
                    <p style="color: #6b7280; margin-top: 15px; font-size: 0.9rem;">
                        Je ontvangt een bevestigingsmail met alle details!
                    </p>
                </div>
            `;
            
            openModal('successModal');
        }

        // Email Functionality
        async function sendConfirmationEmail(booking) {
            const func = functions.find(f => f.id === booking.functionId);
            
            const templateParams = {
                to_name: booking.name,
                to_email: booking.email,
                function_name: func.name,
                function_description: func.description,
                date: formatDate(booking.date),
                start_time: booking.startTime,
                end_time: booking.endTime,
                phone: booking.phone || 'Niet opgegeven'
            };

            try {
                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams,
                    EMAILJS_CONFIG.publicKey
                );
                console.log('‚úÖ Confirmation email sent');
            } catch (error) {
                console.error('‚ùå Error sending email:', error);
            }
        }

        // Evaluation Section
        function checkEvaluationAvailability() {
            const today = new Date();
            const evaluationDate = new Date('2025-10-18');
            
            if (today >= evaluationDate) {
                document.getElementById('evaluationForm').style.display = 'block';
                document.getElementById('evaluationClosed').style.display = 'none';
                
                // Generate dynamic form based on evaluation questions
                generateDynamicEvaluationForm();
            } else {
                document.getElementById('evaluationForm').style.display = 'none';
                document.getElementById('evaluationClosed').style.display = 'block';
            }
        }
        
        function generateDynamicEvaluationForm() {
            const formContainer = document.getElementById('evalForm');
            if (!formContainer) return;
            
            // Clear existing form content (except submit button)
            const submitButton = formContainer.querySelector('button[type="submit"]');
            formContainer.innerHTML = '';
            
            // Generate form fields based on evaluationQuestions
            evaluationQuestions.forEach(question => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                let fieldHTML = `
                    <label class="form-label">${question.label}${question.required ? ' *' : ''}:</label>
                `;
                
                switch (question.type) {
                    case 'text':
                        fieldHTML += `<input type="text" id="${question.fieldName}" class="form-input" placeholder="${question.placeholder || ''}" ${question.required ? 'required' : ''}>`;
                        break;
                        
                    case 'textarea':
                        fieldHTML += `<textarea id="${question.fieldName}" class="textarea" placeholder="${question.placeholder || ''}" ${question.required ? 'required' : ''}></textarea>`;
                        break;
                        
                    case 'select':
                        fieldHTML += `<select id="${question.fieldName}" class="form-input" ${question.required ? 'required' : ''}>`;
                        
                        if (question.options === 'functions') {
                            fieldHTML += '<option value="">Kies een functie...</option>';
                            functions.forEach(func => {
                                fieldHTML += `<option value="${func.id}">${func.name}</option>`;
                            });
                        } else if (Array.isArray(question.options)) {
                            question.options.forEach(option => {
                                fieldHTML += `<option value="${option.value}">${option.label}</option>`;
                            });
                        }
                        
                        fieldHTML += '</select>';
                        break;
                        
                    case 'rating':
                        fieldHTML += `
                            <div class="rating-stars" id="${question.fieldName}Rating">
                        `;
                        for (let i = question.min || 1; i <= (question.max || 5); i++) {
                            fieldHTML += `<span class="star" data-rating="${i}">‚≠ê</span>`;
                        }
                        fieldHTML += '</div>';
                        break;
                }
                
                formGroup.innerHTML = fieldHTML;
                formContainer.appendChild(formGroup);
                
                // Setup rating functionality for rating questions
                if (question.type === 'rating') {
                    setupRatingStarsForField(question.fieldName, question.min || 1, question.max || 5);
                }
            });
            
            // Add submit button back
            const submitContainer = document.createElement('div');
            submitContainer.innerHTML = '<button type="submit" class="btn btn-primary">üìù Evaluatie Versturen</button>';
            formContainer.appendChild(submitContainer);
        }
        
        function setupRatingStarsForField(fieldName, min, max) {
            const stars = document.querySelectorAll(`#${fieldName}Rating .star`);
            const container = document.getElementById(`${fieldName}Rating`);
            let selectedRating = 0;

            stars.forEach((star, index) => {
                const rating = parseInt(star.dataset.rating);
                
                // Click event for desktop
                star.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectedRating = rating;
                    updateFieldStars(fieldName, selectedRating, min, max);
                });

                // Touch events for mobile
                star.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    selectedRating = rating;
                    updateFieldStars(fieldName, selectedRating, min, max);
                });

                star.addEventListener('touchend', (e) => {
                    e.preventDefault();
                });

                // Hover effect for desktop only (not on touch devices)
                star.addEventListener('mouseover', () => {
                    if (!('ontouchstart' in window)) {
                        updateFieldStars(fieldName, rating, min, max);
                    }
                });
            });

            // Mouse leave event for desktop only
            if (container && !('ontouchstart' in window)) {
                container.addEventListener('mouseleave', () => {
                    updateFieldStars(fieldName, selectedRating, min, max);
                });
            }

            function updateFieldStars(fieldName, rating, min, max) {
                const fieldStars = document.querySelectorAll(`#${fieldName}Rating .star`);
                fieldStars.forEach((star, index) => {
                    const starRating = parseInt(star.dataset.rating);
                    star.classList.toggle('active', starRating <= rating);
                });
                const ratingContainer = document.getElementById(`${fieldName}Rating`);
                if (ratingContainer) {
                    ratingContainer.dataset.rating = rating;
                }
            }
        }
        
        function updateEvaluationTab() {
            // Refresh the evaluation form when questions change
            if (document.getElementById('evaluationTab').classList.contains('active')) {
                checkEvaluationAvailability();
            }
        }

        // Export Schedule to Print with chronological sorting
        function exportScheduleToPrint() {
            // Create a print window with sorted data
            const printWindow = window.open('', '_blank');
            
            // Sort timeslots chronologically: first by date, then by time
            const sortedSlots = [...timeSlots].sort((a, b) => {
                // First sort by date
                if (a.date !== b.date) {
                    return a.date.localeCompare(b.date);
                }
                // Then sort by start time
                return a.startTime.localeCompare(b.startTime);
            });
            
            // Group slots by date for organized display
            const slotsByDate = {};
            sortedSlots.forEach(slot => {
                if (!slotsByDate[slot.date]) {
                    slotsByDate[slot.date] = [];
                }
                slotsByDate[slot.date].push(slot);
            });
            
            // Generate HTML for print
            let html = `
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halloween 2025 - Vrijwilligersplanning</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 2cm 2.5cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #1f2937;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #16a34a;
        }
        
        .print-header h1 {
            color: #16a34a;
            font-size: 28pt;
            margin-bottom: 8px;
            font-weight: 800;
        }
        
        .print-header p {
            color: #6b7280;
            font-size: 12pt;
        }
        
        .print-date-section {
            page-break-inside: avoid;
            margin-bottom: 30px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .print-date-header {
            background: #16a34a;
            color: white;
            padding: 12px 15px;
            font-size: 14pt;
            font-weight: bold;
        }
        
        .print-timeslots {
            padding: 15px;
        }
        
        .print-timeslot {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .print-timeslot:last-child {
            margin-bottom: 0;
        }
        
        .print-slot-info {
            flex: 1;
        }
        
        .print-function-name {
            font-weight: bold;
            color: #16a34a;
            font-size: 12pt;
            margin-bottom: 4px;
        }
        
        .print-time {
            font-weight: 600;
            color: #374151;
            font-size: 11pt;
        }
        
        .print-capacity {
            color: #6b7280;
            font-size: 10pt;
            text-align: right;
            padding-left: 15px;
        }
        
        .print-capacity-label {
            display: block;
            font-size: 9pt;
            color: #9ca3af;
        }
        
        .print-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            text-align: center;
            color: #6b7280;
            font-size: 9pt;
        }
    </style>
</head>
<body>
    <div class="print-header">
        <h1>üéÉ Halloween 2025</h1>
        <p>Vrijwilligersplanning - De Puzzel</p>
    </div>
`;
            
            // Add date sections in chronological order
            Object.keys(slotsByDate).sort().forEach(date => {
                const dateSlots = slotsByDate[date];
                
                html += `
    <div class="print-date-section">
        <div class="print-date-header">üìÖ ${formatDate(date)}</div>
        <div class="print-timeslots">
`;
                
                // Slots are already sorted by time within each date
                dateSlots.forEach(slot => {
                    const func = functions.find(f => f.id === slot.functionId);
                    const available = slot.capacity - slot.booked;
                    const funcName = func ? func.name : 'Onbekende functie';
                    
                    html += `
            <div class="print-timeslot">
                <div class="print-slot-info">
                    <div class="print-function-name">${funcName}</div>
                    <div class="print-time">üïê ${slot.startTime} - ${slot.endTime}</div>
                </div>
                <div class="print-capacity">
                    <strong>${slot.booked}/${slot.capacity}</strong> geboekt<br>
                    <span class="print-capacity-label">${available} beschikbaar</span>
                </div>
            </div>
`;
                });
                
                html += `
        </div>
    </div>
`;
            });
            
            // Add footer
            const printDate = new Date().toLocaleDateString('nl-NL', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            html += `
    <div class="print-footer">
        <p>Afgedrukt op ${printDate}</p>
    </div>
</body>
</html>
`;
            
            // Write to print window and trigger print
            printWindow.document.write(html);
            printWindow.document.close();
            
            // Wait for content to load before printing
            printWindow.onload = function() {
                printWindow.print();
            };
        }

        async function handleEvaluationSubmit(e) {
            e.preventDefault();
            
            // Collect data from all dynamic form fields
            const evaluation = {
                submittedDate: new Date().toLocaleDateString('nl-NL')
            };
            
            let hasRequiredFieldError = false;
            
            // Process each question and collect its value
            evaluationQuestions.forEach(question => {
                const fieldElement = document.getElementById(question.fieldName);
                let value = null;
                
                switch (question.type) {
                    case 'text':
                    case 'textarea':
                        value = fieldElement ? fieldElement.value.trim() : '';
                        break;
                    case 'select':
                        value = fieldElement ? fieldElement.value : '';
                        break;
                    case 'rating':
                        const ratingElement = document.getElementById(question.fieldName + 'Rating');
                        value = ratingElement ? parseInt(ratingElement.dataset.rating || '0') : 0;
                        break;
                }
                
                // Check required fields
                if (question.required && (!value || (question.type === 'rating' && value < (question.min || 1)))) {
                    showError(`Veld '${question.label}' is verplicht`);
                    hasRequiredFieldError = true;
                    return;
                }
                
                // Store the value (only if not empty for optional fields)
                if (value !== null && value !== '' && !(question.type === 'rating' && value === 0)) {
                    evaluation[question.fieldName] = value;
                }
            });
            
            if (hasRequiredFieldError) {
                return;
            }

            try {
                await window.addDoc(window.collection(window.db, 'evaluations'), evaluation);
                evaluations.push(evaluation);
                
                // Reset form
                document.getElementById('evalForm').reset();
                
                // Reset all rating stars
                evaluationQuestions.forEach(question => {
                    if (question.type === 'rating') {
                        const ratingElement = document.getElementById(question.fieldName + 'Rating');
                        if (ratingElement) {
                            ratingElement.dataset.rating = '0';
                            const stars = ratingElement.querySelectorAll('.star');
                            stars.forEach(star => star.classList.remove('active'));
                        }
                    }
                });
                
                showSuccess('üåü Bedankt voor je evaluatie!');
                
            } catch (error) {
                console.error('‚ùå Error saving evaluation:', error);
                showError('Fout bij het opslaan van de evaluatie');
            }
        }

        // Function Management
        let currentEditingFunction = null;
        
        // Timeslot Management
        let currentEditingTimeslot = null;
        
        function openAddTimeslotModal() {
            currentEditingTimeslot = null;
            document.getElementById('timeslotModalTitle').textContent = '‚ûï Nieuw Tijdslot Toevoegen';
            document.getElementById('timeslotForm').reset();
            
            // Populate function dropdown
            const functionSelect = document.getElementById('timeslotFunction');
            functionSelect.innerHTML = '<option value="">Kies een functie...</option>';
            functions.forEach(func => {
                const option = document.createElement('option');
                option.value = func.id;
                option.textContent = func.name;
                functionSelect.appendChild(option);
            });
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('timeslotDate').value = today;
            
            openModal('timeslotModal');
        }
        
        function editTimeslot(timeslotId) {
            const slot = timeSlots.find(s => s.id === timeslotId);
            if (!slot) return;
            
            currentEditingTimeslot = slot;
            document.getElementById('timeslotModalTitle').textContent = '‚úèÔ∏è Tijdslot Bewerken';
            
            // Populate function dropdown
            const functionSelect = document.getElementById('timeslotFunction');
            functionSelect.innerHTML = '<option value="">Kies een functie...</option>';
            functions.forEach(func => {
                const option = document.createElement('option');
                option.value = func.id;
                option.textContent = func.name;
                option.selected = func.id === slot.functionId;
                functionSelect.appendChild(option);
            });
            
            // Fill form with current values
            document.getElementById('timeslotFunction').value = slot.functionId;
            document.getElementById('timeslotDate').value = slot.date;
            document.getElementById('timeslotStartTime').value = slot.startTime;
            document.getElementById('timeslotEndTime').value = slot.endTime;
            document.getElementById('timeslotCapacity').value = slot.capacity;
            
            openModal('timeslotModal');
        }
        
        async function deleteTimeslot(timeslotId) {
            const slot = timeSlots.find(s => s.id === timeslotId);
            if (!slot) return;
            
            const func = functions.find(f => f.id === slot.functionId);
            const funcName = func ? func.name : 'Onbekende functie';
            
            // Check if timeslot has bookings
            const slotBookings = bookings.filter(booking => booking.slotId === timeslotId);
            
            if (slotBookings.length > 0) {
                showError(`Kan tijdslot niet verwijderen omdat er nog ${slotBookings.length} boeking(en) aan gekoppeld zijn.`);
                return;
            }
            
            if (!confirm(`Weet je zeker dat je het tijdslot "${funcName} op ${formatDate(slot.date)} van ${slot.startTime}-${slot.endTime}" wilt verwijderen?`)) {
                return;
            }
            
            try {
                // Delete from Firebase
                if (slot.firebaseId) {
                    await window.deleteDoc(window.doc(window.db, 'timeSlots', slot.firebaseId));
                }
                
                // Remove from local array
                timeSlots = timeSlots.filter(s => s.id !== timeslotId);
                
                showSuccess('Tijdslot succesvol verwijderd');
                
                // Refresh UI
                initializeUI();
                showAdminSection('timeslots');
                
            } catch (error) {
                console.error('Error deleting timeslot:', error);
                showError('Fout bij het verwijderen van het tijdslot');
            }
        }
        
        async function handleTimeslotSubmit(e) {
            e.preventDefault();
            
            const functionId = document.getElementById('timeslotFunction').value;
            const date = document.getElementById('timeslotDate').value;
            const startTime = document.getElementById('timeslotStartTime').value;
            const endTime = document.getElementById('timeslotEndTime').value;
            const capacity = parseInt(document.getElementById('timeslotCapacity').value);
            
            if (!functionId || !date || !startTime || !endTime || !capacity) {
                showError('Vul alle verplichte velden in');
                return;
            }
            
            // Validate time
            if (startTime >= endTime) {
                showError('Start tijd moet voor eind tijd liggen');
                return;
            }
            
            // Check for overlapping timeslots for the same function on the same date
            const overlappingSlots = timeSlots.filter(slot => {
                if (currentEditingTimeslot && slot.id === currentEditingTimeslot.id) {
                    return false; // Skip current slot when editing
                }
                return slot.functionId === functionId && 
                       slot.date === date && 
                       ((startTime >= slot.startTime && startTime < slot.endTime) ||
                        (endTime > slot.startTime && endTime <= slot.endTime) ||
                        (startTime <= slot.startTime && endTime >= slot.endTime));
            });
            
            if (overlappingSlots.length > 0) {
                showError('Er bestaat al een tijdslot voor deze functie dat overlapt met de gekozen tijd');
                return;
            }
            
            try {
                if (currentEditingTimeslot) {
                    // Update existing timeslot
                    const timeslotData = {
                        functionId,
                        date,
                        startTime,
                        endTime,
                        capacity
                    };
                    
                    // Update in Firebase if it has a Firebase ID
                    if (currentEditingTimeslot.firebaseId) {
                        const timeslotRef = window.doc(window.db, 'timeSlots', currentEditingTimeslot.firebaseId);
                        await window.updateDoc(timeslotRef, timeslotData);
                    }
                    
                    // Update local data
                    const index = timeSlots.findIndex(s => s.id === currentEditingTimeslot.id);
                    if (index !== -1) {
                        timeSlots[index] = { ...timeSlots[index], ...timeslotData };
                    }
                    
                    showSuccess('Tijdslot succesvol bijgewerkt');
                    
                } else {
                    // Add new timeslot
                    const timeslotData = {
                        id: generateId(),
                        functionId,
                        date,
                        startTime,
                        endTime,
                        capacity,
                        booked: 0,
                        volunteers: []
                    };
                    
                    // Save to Firebase
                    const docRef = await window.addDoc(window.collection(window.db, 'timeSlots'), timeslotData);
                    timeslotData.firebaseId = docRef.id;
                    
                    // Add to local array
                    timeSlots.push(timeslotData);
                    
                    showSuccess('Tijdslot succesvol toegevoegd');
                }
                
                // Refresh UI
                initializeUI();
                closeModal('timeslotModal');
                showAdminSection('timeslots');
                
            } catch (error) {
                console.error('Error saving timeslot:', error);
                showError('Fout bij het opslaan van het tijdslot');
            }
        }
        
        function openAddFunctionModal() {
            currentEditingFunction = null;
            document.getElementById('functionModalTitle').textContent = '‚ûï Nieuwe Functie Toevoegen';
            document.getElementById('functionForm').reset();
            
            // Set default color to next available color
            const defaultColorIndex = functions.length % functionColors.length;
            document.getElementById('functionColorIndex').value = defaultColorIndex;
            
            // Setup color picker with default selection
            setupColorPicker(defaultColorIndex);
            
            openModal('functionModal');
        }
        
        function selectColor(index) {
            document.getElementById('functionColorIndex').value = index;
            
            // Update visual selection
            const colorOptions = document.querySelectorAll('#colorPicker > div');
            colorOptions.forEach((option, i) => {
                option.style.border = i === index ? '3px solid #000' : '3px solid transparent';
            });
        }
        
        function setupColorPicker(selectedIndex = 0) {
            const colorPicker = document.getElementById('colorPicker');
            colorPicker.innerHTML = '';
            
            functionColors.forEach((color, index) => {
                const colorOption = document.createElement('div');
                colorOption.style.cssText = `
                    width: 40px;
                    height: 40px;
                    background: ${color.gradient};
                    border-radius: 8px;
                    cursor: pointer;
                    border: 3px solid ${index === selectedIndex ? '#000' : 'transparent'};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 0.8rem;
                    transition: all 0.3s ease;
                `;
                colorOption.textContent = color.name.substring(0, 1);
                
                // Add click event listener to prevent bubbling
                colorOption.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectColor(index);
                });
                
                colorPicker.appendChild(colorOption);
            });
        }
        
        function editFunction(functionId) {
            const func = functions.find(f => f.id === functionId);
            if (!func) return;
            
            currentEditingFunction = func;
            document.getElementById('functionModalTitle').textContent = '‚úèÔ∏è Functie Bewerken';
            document.getElementById('functionName').value = func.name;
            document.getElementById('functionDescription').value = func.description;
            
            // Use stored colorIndex or fallback to position-based
            let colorIndex = 0;
            if (func.colorIndex !== undefined) {
                colorIndex = func.colorIndex;
            } else {
                // Fallback for legacy functions
                const functionIndex = functions.findIndex(f => f.id === functionId);
                colorIndex = functionIndex % functionColors.length;
            }
            
            document.getElementById('functionColorIndex').value = colorIndex;
            
            // Setup color picker with current selection
            setupColorPicker(colorIndex);
            
            openModal('functionModal');
        }
        
        async function deleteFunction(functionId) {
            const func = functions.find(f => f.id === functionId);
            if (!func) return;
            
            // Check if function has any timeslots or bookings
            const funcSlots = timeSlots.filter(slot => slot.functionId === functionId);
            const funcBookings = bookings.filter(booking => booking.functionId === functionId);
            
            if (funcSlots.length > 0 || funcBookings.length > 0) {
                showError(`Kan functie "${func.name}" niet verwijderen omdat er nog tijdsloten (${funcSlots.length}) of boekingen (${funcBookings.length}) aan gekoppeld zijn.`);
                return;
            }
            
            if (!confirm(`Weet je zeker dat je de functie "${func.name}" wilt verwijderen?`)) {
                return;
            }
            
            try {
                // Delete from Firebase
                const functionDoc = functions.find(f => f.id === functionId);
                if (functionDoc.firebaseId) {
                    await window.deleteDoc(window.doc(window.db, 'functions', functionDoc.firebaseId));
                }
                
                // Remove from local array
                functions = functions.filter(f => f.id !== functionId);
                
                showSuccess(`Functie "${func.name}" succesvol verwijderd`);
                
                // Refresh UI
                initializeUI();
                showAdminSection('functions');
                
            } catch (error) {
                console.error('Error deleting function:', error);
                showError('Fout bij het verwijderen van de functie');
            }
        }
        
        async function handleFunctionSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('functionName').value.trim();
            const description = document.getElementById('functionDescription').value.trim();
            const colorIndex = parseInt(document.getElementById('functionColorIndex').value);
            
            if (!name || !description) {
                showError('Vul alle verplichte velden in');
                return;
            }
            
            // Check for duplicate names (excluding current function when editing)
            const existingFunction = functions.find(f => 
                f.name.toLowerCase() === name.toLowerCase() && 
                (!currentEditingFunction || f.id !== currentEditingFunction.id)
            );
            
            if (existingFunction) {
                showError('Er bestaat al een functie met deze naam');
                return;
            }
            
            try {
                if (currentEditingFunction) {
                    // Update existing function
                    const functionData = {
                        name,
                        description,
                        colorIndex // Include color index
                    };
                    
                    // Update in Firebase if it has a Firebase ID
                    if (currentEditingFunction.firebaseId) {
                        const functionRef = window.doc(window.db, 'functions', currentEditingFunction.firebaseId);
                        await window.updateDoc(functionRef, functionData);
                    }
                    
                    // Update local data
                    const index = functions.findIndex(f => f.id === currentEditingFunction.id);
                    if (index !== -1) {
                        functions[index] = { ...functions[index], ...functionData };
                    }
                    
                    showSuccess(`Functie "${name}" succesvol bijgewerkt`);
                    
                } else {
                    // Add new function
                    const functionData = {
                        id: generateId(),
                        name,
                        description,
                        colorIndex // Include color index
                    };
                    
                    // Save to Firebase
                    const docRef = await window.addDoc(window.collection(window.db, 'functions'), functionData);
                    functionData.firebaseId = docRef.id;
                    
                    // Add to local array
                    functions.push(functionData);
                    
                    showSuccess(`Functie "${name}" succesvol toegevoegd`);
                }
                
                // Refresh UI
                initializeUI();
                closeModal('functionModal');
                showAdminSection('functions');
                
            } catch (error) {
                console.error('Error saving function:', error);
                showError('Fout bij het opslaan van de functie');
            }
        }

        // Admin Panel
        function handleAdminLogin(e) {
            e.preventDefault();
            
            const password = document.getElementById('adminPassword').value;
            const correctPassword = 'puzzel2025'; // Simple password for demo
            
            if (password === correctPassword) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                showAdminSection('overview');
                showSuccess('üîì Admin ingelogd');
            } else {
                showError('‚ùå Onjuist wachtwoord');
            }
        }

        function showAdminSection(section) {
            // Update button states based on section
            document.querySelectorAll('.admin-nav .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // Find and activate the correct button based on onclick attribute
            document.querySelectorAll('.admin-nav .btn').forEach(btn => {
                const onclickAttr = btn.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${section}'`)) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                }
            });

            const content = document.getElementById('adminContent');
            
            switch(section) {
                case 'overview':
                    showAdminOverview(content);
                    break;
                case 'bookings':
                    showAdminBookings(content);
                    break;
                case 'functions':
                    showAdminFunctions(content);
                    break;
                case 'timeslots':
                    showAdminTimeslots(content);
                    break;
                case 'evaluations':
                    showAdminEvaluations(content);
                    break;
                case 'evaluation-form':
                    showAdminEvaluationForm(content);
                    break;
                case 'settings':
                    showAdminSettings(content);
                    break;
            }
        }

        function showAdminOverview(container) {
            const totalSlots = timeSlots.length;
            const totalCapacity = timeSlots.reduce((sum, slot) => sum + slot.capacity, 0);
            const totalBooked = timeSlots.reduce((sum, slot) => sum + slot.booked, 0);
            const totalAvailable = totalCapacity - totalBooked;
            const fillRate = totalCapacity > 0 ? Math.round((totalBooked / totalCapacity) * 100) : 0;

            container.innerHTML = `
                <div class="card">
                    <h2>üìä Halloween 2025 - Admin Overzicht</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${functions.length}</div>
                            <div class="stat-label">Functies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalSlots}</div>
                            <div class="stat-label">Tijdsloten</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${bookings.length}</div>
                            <div class="stat-label">Boekingen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${fillRate}%</div>
                            <div class="stat-label">Bezetting</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalAvailable}</div>
                            <div class="stat-label">Beschikbaar</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${evaluations.length}</div>
                            <div class="stat-label">Evaluaties</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3>Snelle Acties</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="exportBookingsCSV()">üìä Export Boekingen</button>
                            <button class="btn btn-primary" onclick="sendReminderEmails()">üìß Verzend Herinneringen</button>
                            <button class="btn btn-secondary" onclick="showAdminSection('functions')">üéØ Beheer Functies</button>
                            <button class="btn btn-secondary" onclick="showAdminSection('timeslots')">‚è∞ Beheer Tijdsloten</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAdminBookings(container) {
            let html = `
                <div class="card">
                    <h2>üë• Alle Boekingen (${bookings.length})</h2>
                    
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden;">
                            <thead>
                                <tr style="background: var(--primary-color); color: white;">
                                    <th style="padding: 12px; text-align: left;">Naam</th>
                                    <th style="padding: 12px; text-align: left;">E-mail</th>
                                    <th style="padding: 12px; text-align: left;">Telefoon</th>
                                    <th style="padding: 12px; text-align: left;">Functie</th>
                                    <th style="padding: 12px; text-align: left;">Datum</th>
                                    <th style="padding: 12px; text-align: left;">Tijd</th>
                                    <th style="padding: 12px; text-align: center;">Acties</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (bookings.length === 0) {
                html += `
                    <tr>
                        <td colspan="7" style="padding: 40px; text-align: center; color: #6b7280;">
                            Nog geen boekingen ontvangen
                        </td>
                    </tr>
                `;
            } else {
                bookings.forEach((booking, index) => {
                    const func = functions.find(f => f.id === booking.functionId);
                    const bookingDate = new Date(booking.bookingDate).toLocaleDateString('nl-NL');
                    html += `
                        <tr style="border-bottom: 1px solid #e5e7eb;" data-booking-index="${index}">
                            <td style="padding: 12px; font-weight: 600;">${booking.name}</td>
                            <td style="padding: 12px;"><a href="mailto:${booking.email}" style="color: var(--primary-color);">${booking.email}</a></td>
                            <td style="padding: 12px;">${booking.phone || 'Niet opgegeven'}</td>
                            <td style="padding: 12px; color: var(--primary-color); font-weight: 500;">${func ? func.name : 'Onbekend'}</td>
                            <td style="padding: 12px;">${formatDate(booking.date)}</td>
                            <td style="padding: 12px;">${booking.startTime} - ${booking.endTime}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button class="btn admin-delete-booking-btn" style="padding: 6px 10px; font-size: 0.8rem; background: #dc2626; color: white;" 
                                        data-booking-id="${booking.id || index}" 
                                        data-timeslot-id="${booking.slotId}" 
                                        data-booking-email="${booking.email}"
                                        data-booking-name="${booking.name}">
                                    üóëÔ∏è Verwijder
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="exportBookingsCSV()">üìä Export naar CSV</button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.admin-delete-booking-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const bookingId = this.getAttribute('data-booking-id');
                    const timeslotId = this.getAttribute('data-timeslot-id');
                    const bookingEmail = this.getAttribute('data-booking-email');
                    const bookingName = this.getAttribute('data-booking-name');
                    
                    deleteBookingFromAdmin(bookingId, timeslotId, bookingEmail, bookingName);
                });
            });
        }

        function showAdminFunctions(container) {
            let html = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üéØ Functies Beheer (${functions.length})</h2>
                        <button class="btn btn-primary" onclick="openAddFunctionModal()">‚ûï Nieuwe Functie</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;" id="functionsGrid">
            `;
            
            functions.forEach((func, index) => {
                // Use stored colorIndex or fallback to position-based
                let colorIndex = index;
                if (func.colorIndex !== undefined) {
                    colorIndex = func.colorIndex;
                }
                const color = getFunctionColor(colorIndex);
                const funcSlots = timeSlots.filter(slot => slot.functionId === func.id);
                const totalCapacity = funcSlots.reduce((sum, slot) => sum + slot.capacity, 0);
                const totalBooked = funcSlots.reduce((sum, slot) => sum + slot.booked, 0);
                
                html += `
                    <div style="background: ${color.bg}; border-radius: 12px; padding: 20px; border: 2px solid ${color.primary}30; position: relative;" data-function-id="${func.id}">
                        <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 5px;">
                            <button class="btn function-edit-btn" style="padding: 6px 10px; font-size: 0.8rem; background: white; color: ${color.primary}; border: 1px solid ${color.primary};" data-function-id="${func.id}">‚úèÔ∏è Bewerk</button>
                            <button class="btn function-delete-btn" style="padding: 6px 10px; font-size: 0.8rem; background: #dc2626; color: white;" data-function-id="${func.id}">üóëÔ∏è Verwijder</button>
                        </div>
                        
                        <h4 style="color: ${color.primary}; margin-bottom: 10px; margin-right: 120px;">${func.name}</h4>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">${func.description}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: ${color.primary};">${totalCapacity}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">Capaciteit</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: #f59e0b;">${totalBooked}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">Geboekt</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: ${totalCapacity - totalBooked > 0 ? '#16a34a' : '#dc2626'};">${totalCapacity - totalBooked}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">Beschikbaar</div>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 10px;">
                            ${funcSlots.length} tijdsloten beschikbaar
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 6px; font-size: 0.8rem;">
                            <strong>Kleur:</strong> ${color.name} <span style="display: inline-block; width: 15px; height: 15px; background: ${color.primary}; border-radius: 3px; margin-left: 5px;"></span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Add event listeners after HTML is rendered
            document.querySelectorAll('.function-edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const functionId = this.getAttribute('data-function-id');
                    editFunction(functionId);
                });
            });
            
            document.querySelectorAll('.function-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const functionId = this.getAttribute('data-function-id');
                    deleteFunction(functionId);
                });
            });
        }

        function showAdminTimeslots(container) {
            const slotsByDate = {};
            timeSlots.forEach(slot => {
                if (!slotsByDate[slot.date]) {
                    slotsByDate[slot.date] = [];
                }
                slotsByDate[slot.date].push(slot);
            });

            let html = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>‚è∞ Tijdsloten Beheer (${timeSlots.length})</h2>
                        <button class="btn btn-primary" onclick="openAddTimeslotModal()">‚ûï Nieuw Tijdslot</button>
                    </div>
            `;
            
            Object.keys(slotsByDate).sort().forEach(date => {
                const dateSlots = slotsByDate[date];
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 15px;">${formatDate(date)}</h3>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background: var(--primary-color); color: white;">
                                        <th style="padding: 10px; text-align: left;">Tijd</th>
                                        <th style="padding: 10px; text-align: left;">Functie</th>
                                        <th style="padding: 10px; text-align: center;">Capaciteit</th>
                                        <th style="padding: 10px; text-align: center;">Geboekt</th>
                                        <th style="padding: 10px; text-align: center;">Beschikbaar</th>
                                        <th style="padding: 10px; text-align: center;">Acties</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                dateSlots.sort((a, b) => a.startTime.localeCompare(b.startTime)).forEach(slot => {
                    const func = functions.find(f => f.id === slot.functionId);
                    const available = slot.capacity - slot.booked;
                    const color = getFunctionColorById(slot.functionId);
                    
                    html += `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 10px; font-weight: 600;">${slot.startTime} - ${slot.endTime}</td>
                            <td style="padding: 8px 10px;">
                                <span style="color: ${color.primary}; font-weight: 600;">${func ? func.name : 'Onbekend'}</span>
                            </td>
                            <td style="padding: 8px 10px; text-align: center; font-weight: 600;">${slot.capacity}</td>
                            <td style="padding: 8px 10px; text-align: center; color: #f59e0b; font-weight: 600;">${slot.booked}</td>
                            <td style="padding: 8px 10px; text-align: center; color: ${available > 0 ? '#16a34a' : '#dc2626'}; font-weight: 600;">${available}</td>
                            <td style="padding: 8px 10px; text-align: center;">
                                <div style="display: flex; gap: 5px; justify-content: center;">
                                    <button class="btn timeslot-edit-btn" style="padding: 4px 8px; font-size: 0.7rem; background: ${color.primary}; color: white;" data-timeslot-id="${slot.id}">‚úèÔ∏è Bewerk</button>
                                    ${slot.booked > 0 ? `<button class="btn timeslot-bookings-btn" style="padding: 4px 8px; font-size: 0.7rem; background: #0891b2; color: white;" data-timeslot-id="${slot.id}">üë• Boekingen (${slot.booked})</button>` : ''}
                                    <button class="btn timeslot-delete-btn" style="padding: 4px 8px; font-size: 0.7rem; background: #dc2626; color: white;" data-timeslot-id="${slot.id}">üóëÔ∏è Verwijder</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Add event listeners after HTML is rendered
            document.querySelectorAll('.timeslot-edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const timeslotId = this.getAttribute('data-timeslot-id');
                    editTimeslot(timeslotId);
                });
            });
            
            document.querySelectorAll('.timeslot-bookings-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const timeslotId = this.getAttribute('data-timeslot-id');
                    showTimeslotBookings(timeslotId);
                });
            });
            
            document.querySelectorAll('.timeslot-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const timeslotId = this.getAttribute('data-timeslot-id');
                    deleteTimeslot(timeslotId);
                });
            });
        }

        function showAdminEvaluations(container) {
            let html = `
                <div class="card">
                    <h2>‚≠ê Evaluaties Overzicht (${evaluations.length})</h2>
            `;
            
            if (evaluations.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üìù</div>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">Nog geen evaluaties ontvangen</div>
                        <div style="font-size: 0.9rem;">Evaluaties worden beschikbaar na 18 oktober 2025</div>
                    </div>
                `;
            } else {
                const avgRating = evaluations.reduce((sum, eval) => sum + eval.organizationRating, 0) / evaluations.length;
                const volunteerAgainCount = evaluations.filter(eval => eval.volunteerAgain === 'yes').length;
                const volunteerAgainPercentage = (volunteerAgainCount / evaluations.length * 100).toFixed(1);
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div class="stat-card">
                            <div class="stat-number">${avgRating.toFixed(1)}/5</div>
                            <div class="stat-label">‚≠ê Gemiddelde Beoordeling</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${volunteerAgainPercentage}%</div>
                            <div class="stat-label">‚úÖ Wil Opnieuw Vrijwilliger Zijn</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${evaluations.length}</div>
                            <div class="stat-label">üìù Totaal Evaluaties</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="exportEvaluationsReport()" style="margin-bottom: 20px;">
                        üìä Export Evaluatie Rapport
                    </button>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function showAdminEvaluationForm(container) {
            let html = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h2>üìù Evaluatie Formulier Beheer (${evaluationQuestions.length})</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="loadExampleEvaluationForm()">üìö Laad Voorbeeld Formulier</button>
                            <button class="btn btn-primary" onclick="openAddEvaluationQuestionModal()">‚ûï Nieuwe Vraag</button>
                        </div>
                    </div>
            `;
            
            if (evaluationQuestions.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üìã</div>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">Nog geen evaluatievragen</div>
                        <div style="font-size: 0.9rem;">Voeg vragen toe om het evaluatieformulier in te richten</div>
                    </div>
                `;
            } else {
                // Show current questions
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px;">Huidige Vragen</h3>
                        <div style="display: grid; gap: 15px;">
                `;
                
                evaluationQuestions.forEach((question, index) => {
                    const typeLabel = {
                        'text': 'Tekstveld',
                        'textarea': 'Tekstgebied', 
                        'select': 'Keuzelijst',
                        'rating': 'Sterren beoordeling'
                    }[question.type] || question.type;
                    
                    html += `
                        <div class="function-card" style="padding: 15px; border: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-color); margin-bottom: 5px;">
                                        ${question.order}. ${question.label}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 5px;">
                                        Type: <strong>${typeLabel}</strong> | Veld: <code>${question.fieldName}</code> | 
                                        ${question.required ? '<span style="color: #dc2626;">Verplicht</span>' : '<span style="color: #6b7280;">Optioneel</span>'}
                                    </div>
                                    ${question.placeholder ? `<div style="font-size: 0.8rem; color: #9ca3af;">Placeholder: "${question.placeholder}"</div>` : ''}
                                    ${question.type === 'rating' ? `<div style="font-size: 0.8rem; color: #9ca3af;">Bereik: ${question.min || 1}-${question.max || 5}</div>` : ''}
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 0.8rem;" onclick="editEvaluationQuestion('${question.id}')">‚úèÔ∏è Bewerken</button>
                                    <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 0.8rem; background: #dc2626; color: white;" onclick="deleteEvaluationQuestion('${question.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Voorbeeld Formulier</h3>
                        <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px;">
                            <div id="evaluationPreview">
                                ${renderEvaluationFormPreview()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function showAdminSettings(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>‚öôÔ∏è Instellingen</h2>
                    
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h3>üîÑ Data Beheer</h3>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                                <button class="btn btn-secondary" onclick="exportAllData()">üì• Export Alle Data</button>
                                <button class="btn btn-secondary" onclick="generateHalloweenData()">üéÉ Genereer Halloween Data</button>
                                <button class="btn btn-secondary" onclick="clearAllData()">üóëÔ∏è Wis Alle Data</button>
                            </div>
                        </div>
                        
                        <div>
                            <h3>üìß E-mail Instellingen</h3>
                            <p style="color: #6b7280; margin-bottom: 10px;">EmailJS configuratie voor automatische bevestigingsmails.</p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="testEmail()">üì® Test E-mail</button>
                                <button class="btn btn-secondary" onclick="sendReminderEmails()">üì¢ Verzend Herinneringen</button>
                            </div>
                        </div>
                        
                        <div>
                            <h3>üìä Systeem Status</h3>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <p><strong>Firebase:</strong> <span style="color: #16a34a;">‚úÖ Verbonden</span></p>
                                <p><strong>EmailJS:</strong> <span style="color: #16a34a;">‚úÖ Actief</span></p>
                                <p><strong>Laatste Update:</strong> ${new Date().toLocaleString('nl-NL')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Export Functions
        function exportBookingsCSV() {
            if (bookings.length === 0) {
                showError('Geen boekingen om te exporteren');
                return;
            }

            const headers = ['Naam', 'E-mail', 'Telefoon', 'Functie', 'Datum', 'Starttijd', 'Eindtijd', 'Boeking Datum'];
            const csvContent = [headers];

            bookings.forEach(booking => {
                const func = functions.find(f => f.id === booking.functionId);
                const bookingDate = new Date(booking.bookingDate).toLocaleDateString('nl-NL');

                csvContent.push([
                    booking.name || '',
                    booking.email || '',
                    booking.phone || '',
                    func ? func.name : 'Onbekend',
                    booking.date || '',
                    booking.startTime || '',
                    booking.endTime || '',
                    bookingDate
                ]);
            });

            const csvString = csvContent.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Halloween-2025-Boekingen-${new Date().toLocaleDateString('nl-NL').replace(/\//g, '-')}.csv`;
            link.click();

            showSuccess(`üìä CSV ge√´xporteerd met ${bookings.length} boekingen`);
        }

        function exportEvaluationsReport() {
            if (evaluations.length === 0) {
                showError('Geen evaluaties om te exporteren');
                return;
            }

            const headers = ['Naam', 'Functie', 'Beoordeling', 'Positieve Punten', 'Verbeterpunten', 'Wil Opnieuw Vrijwilliger', 'Opmerkingen', 'Datum'];
            const csvContent = [headers];

            evaluations.forEach(evaluation => {
                const func = functions.find(f => f.id === evaluation.functionId);

                csvContent.push([
                    evaluation.name || 'Anoniem',
                    func ? func.name : 'Onbekend',
                    `${evaluation.organizationRating}/5`,
                    evaluation.positive || '',
                    evaluation.improvements || '',
                    evaluation.volunteerAgain === 'yes' ? 'Ja' : evaluation.volunteerAgain === 'no' ? 'Nee' : 'Misschien',
                    evaluation.comments || '',
                    evaluation.submittedDate || ''
                ]);
            });

            const csvString = csvContent.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Halloween-2025-Evaluaties-${new Date().toLocaleDateString('nl-NL').replace(/\//g, '-')}.csv`;
            link.click();

            showSuccess(`üìä Evaluatie rapport ge√´xporteerd met ${evaluations.length} evaluaties`);
        }

        async function sendReminderEmails() {
            if (bookings.length === 0) {
                showError('Geen boekingen om herinneringen naar te sturen');
                return;
            }

            if (!confirm(`Wil je herinneringsmails sturen naar alle ${bookings.length} vrijwilligers?`)) {
                return;
            }

            showSuccess('üìß Herinneringen worden verstuurd...');
            
            let successCount = 0;
            for (const booking of bookings) {
                try {
                    await sendConfirmationEmail(booking);
                    successCount++;
                    await new Promise(resolve => setTimeout(resolve, 500)); // Rate limiting
                } catch (error) {
                    console.error(`Failed to send reminder to ${booking.email}:`, error);
                }
            }

            showSuccess(`‚úÖ ${successCount} herinneringen verstuurd`);
        }

        // Export Schedule to Print Function
        function exportScheduleToPrint() {
            // Create a new window for printing
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            
            // Get current schedule data
            const slotsByDate = {};
            timeSlots.forEach(slot => {
                if (selectedFunction !== 'all' && slot.functionId !== selectedFunction) return;
                
                if (!slotsByDate[slot.date]) {
                    slotsByDate[slot.date] = [];
                }
                slotsByDate[slot.date].push(slot);
            });
            
            // Generate print HTML
            let printHTML = `
                <!DOCTYPE html>
                <html lang="nl">
                <head>
                    <meta charset="UTF-8">
                    <title>Halloween 2025 Planning - De Puzzel</title>
                    <style>
                        body {
                            font-family: 'Arial', sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: white;
                            color: #1f2937;
                            line-height: 1.4;
                        }
                        
                        .print-header {
                            text-align: center;
                            margin-bottom: 30px;
                            padding: 20px;
                            border-bottom: 3px solid #16a34a;
                        }
                        
                        .print-header h1 {
                            color: #16a34a;
                            font-size: 2.5rem;
                            margin-bottom: 10px;
                            font-weight: bold;
                        }
                        
                        .print-header p {
                            font-size: 1.2rem;
                            color: #6b7280;
                            margin: 5px 0;
                        }
                        
                        .print-date-section {
                            page-break-inside: avoid;
                            margin-bottom: 30px;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        
                        .print-date-header {
                            background: #16a34a;
                            color: white;
                            padding: 15px 20px;
                            font-size: 1.4rem;
                            font-weight: bold;
                            margin: 0;
                        }
                        
                        .print-timeslots {
                            padding: 20px;
                        }
                        
                        .print-timeslot {
                            border: 1px solid #d1d5db;
                            border-radius: 6px;
                            padding: 15px;
                            margin-bottom: 15px;
                            background: #f8fafc;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        
                        .print-timeslot-info {
                            flex: 1;
                        }
                        
                        .print-function-name {
                            font-weight: bold;
                            color: #16a34a;
                            font-size: 1.1rem;
                            margin-bottom: 5px;
                        }
                        
                        .print-function-desc {
                            color: #6b7280;
                            font-size: 0.9rem;
                            margin-bottom: 8px;
                        }
                        
                        .print-time {
                            font-weight: 600;
                            font-size: 1rem;
                            color: #374151;
                        }
                        
                        .print-capacity {
                            text-align: right;
                            min-width: 120px;
                        }
                        
                        .print-capacity-available {
                            color: #16a34a;
                            font-weight: bold;
                            font-size: 1.1rem;
                        }
                        
                        .print-capacity-full {
                            color: #dc2626;
                            font-weight: bold;
                            font-size: 1.1rem;
                        }
                        
                        .print-capacity-total {
                            color: #6b7280;
                            font-size: 0.9rem;
                        }
                        
                        .print-footer {
                            margin-top: 40px;
                            text-align: center;
                            color: #6b7280;
                            font-size: 0.9rem;
                            padding-top: 20px;
                            border-top: 1px solid #e5e7eb;
                        }
                        
                        @page {
                            size: A4 landscape;
                            margin: 1.5cm;
                        }
                        
                        @media print {
                            body {
                                font-size: 12px;
                            }
                            
                            .print-date-section {
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>üéÉ Halloween 2025</h1>
                        <p><strong>Vrijwilligersplanning De Puzzel</strong></p>
                        <p>Gegenereerd op: ${new Date().toLocaleDateString('nl-NL', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</p>
                        ${selectedFunction !== 'all' ? `<p><em>Gefilterd op: ${functions.find(f => f.id === selectedFunction)?.name || 'Onbekend'}</em></p>` : ''}
                    </div>
            `;
            
            // Add schedule data
            Object.keys(slotsByDate).sort().forEach(date => {
                const dateSlots = slotsByDate[date];
                
                printHTML += `
                    <div class="print-date-section">
                        <div class="print-date-header">${formatDate(date)}</div>
                        <div class="print-timeslots">
                `;
                
                dateSlots.sort((a, b) => a.startTime.localeCompare(b.startTime)).forEach(slot => {
                    const func = functions.find(f => f.id === slot.functionId);
                    const available = slot.capacity - slot.booked;
                    const isAvailable = available > 0;
                    
                    printHTML += `
                        <div class="print-timeslot">
                            <div class="print-timeslot-info">
                                <div class="print-function-name">${func?.name || 'Onbekende functie'}</div>
                                <div class="print-function-desc">${func?.description || ''}</div>
                                <div class="print-time">üïê ${slot.startTime} - ${slot.endTime}</div>
                            </div>
                            <div class="print-capacity">
                                <div class="${isAvailable ? 'print-capacity-available' : 'print-capacity-full'}">
                                    ${isAvailable ? `${available} vrij` : 'VOL'}
                                </div>
                                <div class="print-capacity-total">
                                    ${slot.booked}/${slot.capacity} geboekt
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                printHTML += `
                        </div>
                    </div>
                `;
            });
            
            // Add footer
            const totalCapacity = timeSlots.reduce((sum, slot) => sum + slot.capacity, 0);
            const totalBooked = timeSlots.reduce((sum, slot) => sum + slot.booked, 0);
            const totalAvailable = totalCapacity - totalBooked;
            
            printHTML += `
                    <div class="print-footer">
                        <p><strong>Totaal overzicht:</strong> ${totalBooked}/${totalCapacity} plekken geboekt (‚ãÖ ${totalAvailable} beschikbaar)</p>
                        <p>Voor meer informatie en boekingen: zie online planning systeem</p>
                        <p><em>De Puzzel - Halloween 2025 Vrijwilligersplanning</em></p>
                    </div>
                </body>
                </html>
            `;
            
            // Write to print window and print
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for content to load, then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    // Close window after printing (user can cancel)
                    setTimeout(() => {
                        if (!printWindow.closed) {
                            printWindow.close();
                        }
                    }, 1000);
                }, 500);
            };
            
            showSuccess('üñ®Ô∏è Print venster geopend - planning klaar voor afdrukken!');
        }

        // Print Schedule Export
        function exportScheduleToPrint() {
            // Create print content
            const printContent = generatePrintableSchedule();
            
            // Open new window for printing
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.open();
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Halloween 2025 - Vrijwilligers Planning</title>
                    <style>
                        @page {
                            size: A4 landscape;
                            margin: 1cm;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 11px;
                            line-height: 1.3;
                            color: #000;
                            margin: 0;
                            padding: 0;
                        }
                        
                        .print-header {
                            text-align: center;
                            margin-bottom: 15px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #16a34a;
                        }
                        
                        .print-header h1 {
                            font-size: 18px;
                            margin: 0 0 5px 0;
                            color: #16a34a;
                        }
                        
                        .print-header .subtitle {
                            font-size: 12px;
                            color: #666;
                            margin: 0;
                        }
                        
                        .print-date-section {
                            page-break-inside: avoid;
                            margin-bottom: 20px;
                        }
                        
                        .print-date-header {
                            background: #16a34a;
                            color: white;
                            padding: 8px 12px;
                            font-size: 14px;
                            font-weight: bold;
                            margin-bottom: 8px;
                        }
                        
                        .print-schedule-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 15px;
                            font-size: 10px;
                        }
                        
                        .print-schedule-table th {
                            background: #f0f9f4;
                            border: 1px solid #d1d5db;
                            padding: 6px 8px;
                            text-align: left;
                            font-weight: bold;
                            font-size: 10px;
                        }
                        
                        .print-schedule-table td {
                            border: 1px solid #d1d5db;
                            padding: 5px 8px;
                            vertical-align: top;
                        }
                        
                        .function-name {
                            font-weight: bold;
                            color: #16a34a;
                        }
                        
                        .time-slot {
                            font-weight: 600;
                        }
                        
                        .capacity-info {
                            font-size: 9px;
                            color: #666;
                        }
                        
                        .volunteer-name {
                            display: block;
                            margin-bottom: 3px;
                            font-size: 9px;
                            padding: 2px 0;
                        }
                        
                        .volunteer-name:last-child {
                            margin-bottom: 0;
                        }
                        
                        .no-volunteers {
                            color: #ef4444;
                            font-style: italic;
                            font-size: 9px;
                            padding: 2px 0;
                        }
                        
                        .function-section {
                            page-break-inside: avoid;
                            margin-bottom: 20px;
                            border: 1px solid #e5e7eb;
                            border-radius: 6px;
                            padding: 0;
                            overflow: hidden;
                        }
                        
                        .function-header {
                            border-radius: 4px;
                            margin-bottom: 8px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        
                        .print-footer {
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 1px solid #d1d5db;
                            font-size: 9px;
                            color: #666;
                            text-align: center;
                        }
                        
                        .stats-summary {
                            display: flex;
                            justify-content: space-around;
                            margin-bottom: 15px;
                            font-size: 10px;
                        }
                        
                        .stat-item {
                            text-align: center;
                            padding: 5px;
                        }
                        
                        .stat-number {
                            font-size: 14px;
                            font-weight: bold;
                            color: #16a34a;
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Wait for content to load, then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 100);
            };
        }
        
        function generatePrintableSchedule() {
            const slotsByDate = {};
            
            // Group slots by date
            timeSlots.forEach(slot => {
                if (!slotsByDate[slot.date]) {
                    slotsByDate[slot.date] = [];
                }
                slotsByDate[slot.date].push(slot);
            });
            
            // Calculate statistics using actual bookings
            const totalCapacity = timeSlots.reduce((sum, slot) => sum + slot.capacity, 0);
            const totalActualBooked = timeSlots.reduce((sum, slot) => {
                const slotActualBookings = bookings.filter(booking => booking.slotId === slot.id);
                return sum + slotActualBookings.length;
            }, 0);
            const totalAvailable = totalCapacity - totalActualBooked;
            const fillRate = totalCapacity > 0 ? Math.round((totalActualBooked / totalCapacity) * 100) : 0;
            
            let html = `
                <div class="print-header">
                    <h1>üéÉ Halloween 2025 - Vrijwilligers Planning</h1>
                    <p class="subtitle">De Puzzel ‚Ä¢ Gegenereerd op ${new Date().toLocaleDateString('nl-NL')} om ${new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' })}</p>
                </div>
                
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-number">${functions.length}</div>
                        <div>Functies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${timeSlots.length}</div>
                        <div>Tijdsloten</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${totalActualBooked}</div>
                        <div>Geboekt</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${totalAvailable}</div>
                        <div>Beschikbaar</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${fillRate}%</div>
                        <div>Bezetting</div>
                    </div>
                </div>
            `;
            
            // Generate content for each date
            Object.keys(slotsByDate).sort().forEach(date => {
                const dateSlots = slotsByDate[date];
                
                html += `
                    <div class="print-date-section">
                        <div class="print-date-header">${formatDate(date)}</div>
                `;
                
                // Group slots by function within this date
                const slotsByFunction = {};
                dateSlots.forEach(slot => {
                    if (!slotsByFunction[slot.functionId]) {
                        slotsByFunction[slot.functionId] = [];
                    }
                    slotsByFunction[slot.functionId].push(slot);
                });
                
                // Sort functions by name for consistent ordering
                const sortedFunctionIds = Object.keys(slotsByFunction).sort((a, b) => {
                    const funcA = functions.find(f => f.id === a);
                    const funcB = functions.find(f => f.id === b);
                    return (funcA?.name || '').localeCompare(funcB?.name || '');
                });
                
                // Generate content for each function
                sortedFunctionIds.forEach((functionId, index) => {
                    const functionSlots = slotsByFunction[functionId];
                    const func = functions.find(f => f.id === functionId);
                    const color = getFunctionColorById(functionId);
                    
                    // Calculate function totals using actual bookings
                    const functionCapacity = functionSlots.reduce((sum, slot) => sum + slot.capacity, 0);
                    const functionActualBooked = functionSlots.reduce((sum, slot) => {
                        const slotActualBookings = bookings.filter(booking => booking.slotId === slot.id);
                        return sum + slotActualBookings.length;
                    }, 0);
                    const functionAvailable = functionCapacity - functionActualBooked;
                    
                    html += `
                        <div class="function-section" style="margin-bottom: 20px; ${index > 0 ? 'margin-top: 25px;' : ''}">
                            <div class="function-header" style="background: ${color.primary}; color: white; padding: 10px 15px; margin-bottom: 0; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-weight: bold; font-size: 12px;">${func ? func.name : 'Onbekende Functie'}</div>
                                <div style="font-size: 10px; opacity: 0.9;">${functionActualBooked}/${functionCapacity} bezet ‚Ä¢ ${functionAvailable} vrij</div>
                            </div>
                            
                            <table class="print-schedule-table" style="margin-bottom: 0; border-radius: 0 0 6px 6px; overflow: hidden;">
                                <thead>
                                    <tr style="background-color: rgba(${parseInt(color.primary.slice(1, 3), 16)}, ${parseInt(color.primary.slice(3, 5), 16)}, ${parseInt(color.primary.slice(5, 7), 16)}, 0.1);">
                                        <th style="width: 20%;">Tijd</th>
                                        <th style="width: 15%;">Capaciteit</th>
                                        <th style="width: 12%;">Status</th>
                                        <th style="width: 53%;">Vrijwilligers</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Sort slots by start time
                    functionSlots.sort((a, b) => a.startTime.localeCompare(b.startTime)).forEach(slot => {
                        const slotBookings = bookings.filter(booking => booking.slotId === slot.id);
                        const actualBooked = slotBookings.length; // Use actual bookings count
                        const available = slot.capacity - actualBooked; // Use actual count
                        const isAvailable = available > 0;
                        
                        let volunteersHtml = '';
                        if (slotBookings.length > 0) {
                            volunteersHtml = slotBookings.map(booking => {
                                return `<div class="volunteer-name">‚Ä¢ ${booking.name}</div>`;
                            }).join('');
                        } else {
                            volunteersHtml = '<div class="no-volunteers">üîç Nog geen vrijwilligers</div>';
                        }
                        
                        const statusClass = isAvailable ? '' : ' style="background: #fef2f2;"';
                        const statusText = isAvailable ? `‚úÖ ${available} vrij` : '‚ùå VOL';
                        const statusColor = isAvailable ? '#16a34a' : '#ef4444';
                        
                        html += `
                            <tr${statusClass}>
                                <td class="time-slot" style="font-weight: 600;">${slot.startTime} - ${slot.endTime}</td>
                                <td style="text-align: center; font-weight: 600;">${actualBooked}/${slot.capacity}</td>
                                <td style="text-align: center; font-weight: bold; color: ${statusColor}; font-size: 9px;">${statusText}</td>
                                <td style="line-height: 1.4;">${volunteersHtml}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                html += `
                    </div>
                `;
            });
            
            // Add legend and footer
            html += `
                <div class="print-footer">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 10px;">
                        <div><strong>Symbolen:</strong> ‚úÖ = Beschikbaar | ‚ùå = Vol | üîç = Nog geen vrijwilligers</div>
                        <div><strong>Totaal:</strong> ${totalActualBooked}/${totalCapacity} vrijwilligers (${fillRate}% bezet)</div>
                    </div>
                    <p style="text-align: center; font-weight: bold;">üìã Gebruik deze planning om vrijwilligers in te delen tijdens het evenement</p>
                    <p style="text-align: center; font-size: 8px; color: #666;">Voor wijzigingen: ga naar de online planning ‚Ä¢ Halloween 2025 - De Puzzel</p>
                </div>
            `;
            
            return html;
        }

        // Load Example Evaluation Form
        async function loadExampleEvaluationForm() {
            if (evaluationQuestions.length > 0) {
                if (!confirm('Er bestaan al evaluatievragen. Wil je deze vervangen door het voorbeeld formulier?\n\nDit zal alle huidige vragen verwijderen en vervangen door een standaard evaluatieformulier.')) {
                    return;
                }
                
                // Delete existing questions from Firebase
                try {
                    for (const question of evaluationQuestions) {
                        if (question.firebaseId) {
                            await window.deleteDoc(window.doc(window.db, 'evaluationQuestions', question.firebaseId));
                        }
                    }
                    evaluationQuestions.length = 0; // Clear local array
                } catch (error) {
                    console.error('Error deleting existing questions:', error);
                    showError('Fout bij het verwijderen van bestaande vragen');
                    return;
                }
            }
            
            // Example evaluation form questions
            const exampleQuestions = [
                {
                    id: generateId(),
                    type: 'text',
                    fieldName: 'volunteerName',
                    label: 'Je naam (optioneel)',
                    placeholder: 'Voornaam Achternaam',
                    required: false,
                    order: 1
                },
                {
                    id: generateId(),
                    type: 'select',
                    fieldName: 'volunteerFunction',
                    label: 'Voor welke functie was je vrijwilliger?',
                    options: 'functions',
                    required: true,
                    order: 2
                },
                {
                    id: generateId(),
                    type: 'rating',
                    fieldName: 'organizationRating',
                    label: 'Hoe beoordeel je de algemene organisatie?',
                    min: 1,
                    max: 5,
                    required: true,
                    order: 3
                },
                {
                    id: generateId(),
                    type: 'rating',
                    fieldName: 'communicationRating',
                    label: 'Hoe beoordeel je de communicatie vooraf?',
                    min: 1,
                    max: 5,
                    required: true,
                    order: 4
                },
                {
                    id: generateId(),
                    type: 'rating',
                    fieldName: 'supportRating',
                    label: 'Hoe goed voelde je je ondersteund tijdens het evenement?',
                    min: 1,
                    max: 5,
                    required: true,
                    order: 5
                },
                {
                    id: generateId(),
                    type: 'textarea',
                    fieldName: 'positiveAspects',
                    label: 'Wat ging er goed? (positieve punten)',
                    placeholder: 'Beschrijf wat je positief vond aan het evenement en de organisatie...',
                    required: false,
                    order: 6
                },
                {
                    id: generateId(),
                    type: 'textarea',
                    fieldName: 'improvementSuggestions',
                    label: 'Wat kan er beter? (verbeterpunten)',
                    placeholder: 'Geef concrete suggesties voor verbetering...',
                    required: false,
                    order: 7
                },
                {
                    id: generateId(),
                    type: 'select',
                    fieldName: 'volunteerAgainNextYear',
                    label: 'Wil je volgend jaar weer vrijwilliger zijn?',
                    options: [
                        { value: '', label: 'Maak een keuze...' },
                        { value: 'yes_definitely', label: 'Ja, zeker weten!' },
                        { value: 'yes_probably', label: 'Ja, waarschijnlijk wel' },
                        { value: 'maybe', label: 'Misschien, hangt ervan af' },
                        { value: 'probably_not', label: 'Waarschijnlijk niet' },
                        { value: 'no_definitely', label: 'Nee, zeker niet' }
                    ],
                    required: true,
                    order: 8
                },
                {
                    id: generateId(),
                    type: 'select',
                    fieldName: 'recommendToOthers',
                    label: 'Zou je vrijwilligerswerk bij De Puzzel aanbevelen aan anderen?',
                    options: [
                        { value: '', label: 'Maak een keuze...' },
                        { value: 'yes_enthusiastic', label: 'Ja, zeker aanbevelen!' },
                        { value: 'yes_neutral', label: 'Ja, wel ok√©' },
                        { value: 'neutral', label: 'Neutraal' },
                        { value: 'probably_not', label: 'Waarschijnlijk niet' },
                        { value: 'no', label: 'Nee' }
                    ],
                    required: true,
                    order: 9
                },
                {
                    id: generateId(),
                    type: 'textarea',
                    fieldName: 'additionalComments',
                    label: 'Overige opmerkingen of suggesties',
                    placeholder: 'Heb je nog andere opmerkingen, idee√´n voor nieuwe activiteiten, of algemene feedback?',
                    required: false,
                    order: 10
                },
                {
                    id: generateId(),
                    type: 'select',
                    fieldName: 'contactPermission',
                    label: 'Mogen we je contacteren voor toekomstige vrijwilligersactiviteiten?',
                    options: [
                        { value: '', label: 'Maak een keuze...' },
                        { value: 'yes_all', label: 'Ja, voor alle activiteiten' },
                        { value: 'yes_similar', label: 'Ja, maar alleen voor soortgelijke evenementen' },
                        { value: 'no', label: 'Nee, geen contact' }
                    ],
                    required: false,
                    order: 11
                }
            ];
            
            try {
                // Save example questions to Firebase
                for (const question of exampleQuestions) {
                    const docRef = await window.addDoc(window.collection(window.db, 'evaluationQuestions'), question);
                    question.firebaseId = docRef.id;
                    evaluationQuestions.push(question);
                }
                
                // Sort questions by order
                evaluationQuestions.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                showSuccess(`‚úÖ Voorbeeld evaluatieformulier geladen met ${exampleQuestions.length} vragen!`);
                
                // Refresh UI
                showAdminSection('evaluation-form');
                updateEvaluationTab();
                
            } catch (error) {
                console.error('Error loading example form:', error);
                showError('Fout bij het laden van het voorbeeld formulier');
            }
        }
        let currentEditingQuestion = null;
        
        function openAddEvaluationQuestionModal() {
            currentEditingQuestion = null;
            document.getElementById('evaluationQuestionModalTitle').textContent = '‚ûï Nieuwe Evaluatievraag Toevoegen';
            document.getElementById('evaluationQuestionForm').reset();
            document.getElementById('questionOrder').value = evaluationQuestions.length + 1;
            updateQuestionForm();
            openModal('evaluationQuestionModal');
        }
        
        function editEvaluationQuestion(questionId) {
            const question = evaluationQuestions.find(q => q.id === questionId);
            if (!question) return;
            
            currentEditingQuestion = question;
            document.getElementById('evaluationQuestionModalTitle').textContent = '‚úèÔ∏è Evaluatievraag Bewerken';
            
            // Fill form with current values
            document.getElementById('questionType').value = question.type;
            document.getElementById('questionLabel').value = question.label;
            document.getElementById('questionFieldName').value = question.fieldName;
            document.getElementById('questionPlaceholder').value = question.placeholder || '';
            document.getElementById('questionOrder').value = question.order;
            document.getElementById('questionRequired').checked = question.required;
            
            if (question.type === 'select' && question.options) {
                if (typeof question.options === 'string') {
                    document.getElementById('questionOptions').value = question.options;
                } else {
                    document.getElementById('questionOptions').value = JSON.stringify(question.options, null, 2);
                }
            }
            
            if (question.type === 'rating') {
                document.getElementById('questionMin').value = question.min || 1;
                document.getElementById('questionMax').value = question.max || 5;
            }
            
            updateQuestionForm();
            openModal('evaluationQuestionModal');
        }
        
        function updateQuestionForm() {
            const type = document.getElementById('questionType').value;
            
            // Hide all conditional groups
            document.getElementById('questionPlaceholderGroup').style.display = 'block';
            document.getElementById('questionOptionsGroup').style.display = 'none';
            document.getElementById('questionRatingGroup').style.display = 'none';
            
            // Show relevant groups based on type
            if (type === 'select') {
                document.getElementById('questionOptionsGroup').style.display = 'block';
                document.getElementById('questionPlaceholderGroup').style.display = 'none';
            } else if (type === 'rating') {
                document.getElementById('questionRatingGroup').style.display = 'block';
                document.getElementById('questionPlaceholderGroup').style.display = 'none';
            }
        }
        
        async function deleteEvaluationQuestion(questionId) {
            const question = evaluationQuestions.find(q => q.id === questionId);
            if (!question) return;
            
            if (!confirm(`Weet je zeker dat je de vraag "${question.label}" wilt verwijderen?`)) {
                return;
            }
            
            try {
                // Delete from Firebase
                if (question.firebaseId) {
                    await window.deleteDoc(window.doc(window.db, 'evaluationQuestions', question.firebaseId));
                }
                
                // Remove from local array
                evaluationQuestions = evaluationQuestions.filter(q => q.id !== questionId);
                
                showSuccess('Evaluatievraag succesvol verwijderd');
                
                // Refresh UI
                showAdminSection('evaluation-form');
                
            } catch (error) {
                console.error('Error deleting evaluation question:', error);
                showError('Fout bij het verwijderen van de vraag');
            }
        }
        
        async function handleEvaluationQuestionSubmit(e) {
            e.preventDefault();
            
            const type = document.getElementById('questionType').value;
            const label = document.getElementById('questionLabel').value.trim();
            const fieldName = document.getElementById('questionFieldName').value.trim();
            const placeholder = document.getElementById('questionPlaceholder').value.trim();
            const order = parseInt(document.getElementById('questionOrder').value);
            const required = document.getElementById('questionRequired').checked;
            
            if (!type || !label || !fieldName) {
                showError('Vul alle verplichte velden in');
                return;
            }
            
            // Validate field name (only letters, numbers, underscores)
            if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(fieldName)) {
                showError('Veldnaam mag alleen letters, cijfers en underscores bevatten en moet beginnen met een letter');
                return;
            }
            
            // Check for duplicate field names (excluding current question when editing)
            const existingQuestion = evaluationQuestions.find(q => 
                q.fieldName === fieldName && 
                (!currentEditingQuestion || q.id !== currentEditingQuestion.id)
            );
            
            if (existingQuestion) {
                showError('Er bestaat al een vraag met deze veldnaam');
                return;
            }
            
            try {
                const questionData = {
                    type,
                    label,
                    fieldName,
                    required,
                    order
                };
                
                // Add type-specific fields
                if (placeholder) {
                    questionData.placeholder = placeholder;
                }
                
                if (type === 'select') {
                    const optionsValue = document.getElementById('questionOptions').value.trim();
                    if (optionsValue === 'functions') {
                        questionData.options = 'functions';
                    } else if (optionsValue) {
                        try {
                            questionData.options = JSON.parse(optionsValue);
                        } catch (error) {
                            showError('Ongeldige JSON in opties veld');
                            return;
                        }
                    }
                }
                
                if (type === 'rating') {
                    questionData.min = parseInt(document.getElementById('questionMin').value);
                    questionData.max = parseInt(document.getElementById('questionMax').value);
                    
                    if (questionData.min >= questionData.max) {
                        showError('Min waarde moet kleiner zijn dan max waarde');
                        return;
                    }
                }
                
                if (currentEditingQuestion) {
                    // Update existing question
                    if (currentEditingQuestion.firebaseId) {
                        const questionRef = window.doc(window.db, 'evaluationQuestions', currentEditingQuestion.firebaseId);
                        await window.updateDoc(questionRef, questionData);
                    }
                    
                    // Update local data
                    const index = evaluationQuestions.findIndex(q => q.id === currentEditingQuestion.id);
                    if (index !== -1) {
                        evaluationQuestions[index] = { ...evaluationQuestions[index], ...questionData };
                    }
                    
                    showSuccess('Evaluatievraag succesvol bijgewerkt');
                    
                } else {
                    // Add new question
                    questionData.id = generateId();
                    
                    // Save to Firebase
                    const docRef = await window.addDoc(window.collection(window.db, 'evaluationQuestions'), questionData);
                    questionData.firebaseId = docRef.id;
                    
                    // Add to local array
                    evaluationQuestions.push(questionData);
                    
                    showSuccess('Evaluatievraag succesvol toegevoegd');
                }
                
                // Sort questions by order
                evaluationQuestions.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                // Refresh UI
                closeModal('evaluationQuestionModal');
                showAdminSection('evaluation-form');
                
                // Also refresh the evaluation tab if it uses dynamic questions
                updateEvaluationTab();
                
            } catch (error) {
                console.error('Error saving evaluation question:', error);
                showError('Fout bij het opslaan van de vraag');
            }
        }
        
        function renderEvaluationFormPreview() {
            if (evaluationQuestions.length === 0) {
                return '<p style="color: #6b7280; font-style: italic;">Nog geen vragen toegevoegd</p>';
            }
            
            let html = '<div style="max-width: 500px;">';
            
            evaluationQuestions.forEach(question => {
                html += `
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color);">
                            ${question.label}${question.required ? ' *' : ''}
                        </label>
                `;
                
                switch (question.type) {
                    case 'text':
                        html += `<input type="text" style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px;" placeholder="${question.placeholder || ''}" disabled>`;
                        break;
                    case 'textarea':
                        html += `<textarea style="width: 100%; min-height: 80px; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; resize: vertical;" placeholder="${question.placeholder || ''}" disabled></textarea>`;
                        break;
                    case 'select':
                        html += '<select style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px;" disabled>';
                        if (question.options === 'functions') {
                            html += '<option>Kies een functie...</option>';
                            functions.forEach(func => {
                                html += `<option>${func.name}</option>`;
                            });
                        } else if (Array.isArray(question.options)) {
                            question.options.forEach(option => {
                                html += `<option value="${option.value}">${option.label}</option>`;
                            });
                        }
                        html += '</select>';
                        break;
                    case 'rating':
                        html += '<div style="display: flex; gap: 8px; justify-content: center; margin: 10px 0;">';
                        for (let i = question.min || 1; i <= (question.max || 5); i++) {
                            html += `<span style="font-size: 1.5rem; color: #d1d5db;">‚≠ê</span>`;
                        }
                        html += '</div>';
                        break;
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }
        
        function updateEvaluationTab() {
            // This function will be called to refresh the evaluation form
            // We'll implement the dynamic form generation later
            console.log('Updating evaluation tab with new questions');
        }

        // Clear All Data Function
        async function clearAllData() {
            if (!confirm('WAARSCHUWING: Wil je ALLE data uit Firebase verwijderen?\n\nDit verwijdert:\n- Alle functies\n- Alle tijdsloten\n- Alle boekingen\n- Alle evaluaties\n\nDit kan NIET ongedaan gemaakt worden!')) {
                return;
            }
            
            if (!confirm('Ben je hier echt zeker van? Dit zal alle data permanent verwijderen!')) {
                return;
            }

            try {
                showLoading(true);
                
                // Delete all collections
                const collections = ['functions', 'timeSlots', 'bookings', 'evaluations', 'evaluationQuestions'];
                let totalDeleted = 0;
                
                for (const collectionName of collections) {
                    const snapshot = await window.getDocs(window.collection(window.db, collectionName));
                    
                    for (const doc of snapshot.docs) {
                        await window.deleteDoc(window.doc(window.db, collectionName, doc.id));
                        totalDeleted++;
                    }
                }
                
                // Clear local arrays
                functions.length = 0;
                timeSlots.length = 0;
                bookings.length = 0;
                evaluations.length = 0;
                evaluationQuestions.length = 0;
                
                showLoading(false);
                showSuccess(`‚úÖ ${totalDeleted} documenten verwijderd uit Firebase`);
                
                // Refresh UI
                initializeUI();
                showAdminSection('overview');
                
            } catch (error) {
                showLoading(false);
                console.error('‚ùå Error clearing data:', error);
                showError('Fout bij het wissen van data: ' + error.message);
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        console.log('üéÉ Halloween 2025 Volunteer Planning System Ready!');
    </script>

    <!-- Footer -->
    <div class="container">
        <div class="footer">
            <p>Ontwikkeld door <strong>Thomas Van Troostenberghe</strong></p>
        </div>
    </div>
</body>
</html>
