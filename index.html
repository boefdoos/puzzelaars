<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>De Puzzel - Halloween 2025 Vrijwilligers</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- EmailJS CDN -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDbDBDthwZiqRJNtCjhhfPV28ijoRDjlvU",
            authDomain: "de-puzzel.firebaseapp.com",
            projectId: "de-puzzel",
            storageBucket: "de-puzzel.firebasestorage.app",
            messagingSenderId: "995719179078",
            appId: "1:995719179078:web:5d33b215d15ac57f72d347",
            measurementId: "G-6MTF4QEW3Y"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;

        console.log('✅ Firebase initialized successfully');

        // Initialize app after Firebase is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing app...');
            if (typeof window.initializeApp === 'function') {
                window.initializeApp();
            }
        });
    </script>

    <style>
        :root {
            --primary-color: #16a34a;
            --primary-light: #22c55e;
            --primary-dark: #15803d;
            --secondary-color: #0891b2;
            --accent-color: #ea580c;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --background: #f9fafb;
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9f4 0%, #e8f5e8 50%, #dcf4e3 100%);
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .header-logo {
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 8px;
            box-shadow: var(--shadow);
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 12px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .tab-btn:hover {
            background: rgba(22, 163, 74, 0.1);
            color: var(--primary-color);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(34, 197, 94, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: var(--text-color);
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7) !important;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white !important;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 1001;
            border: none !important;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .success-message {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .error-message {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .loading.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .modal-content {
                padding: 25px;
                margin: 20px;
            }
        }

        /* Priority Functions Styles */
        .priority-section {
            background: linear-gradient(145deg, var(--accent-color), #f97316);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .priority-functions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .priority-function {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .priority-function:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.02);
        }

        /* Schedule Grid Styles */
        .schedule-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .date-section {
            border-left: 4px solid var(--primary-color);
            padding-left: 20px;
            margin-bottom: 30px;
        }

        .date-header {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .function-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .function-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.15);
        }

        .timeslots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .timeslot {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeslot.available {
            border-color: var(--primary-color);
            background: rgba(22, 163, 74, 0.05);
            cursor: pointer;
        }

        .timeslot.available:hover {
            background: rgba(22, 163, 74, 0.15);
            transform: scale(1.03);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.3);
        }

        .timeslot.full {
            background: rgba(239, 68, 68, 0.05);
            border-color: #ef4444;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Admin Panel Styles */
        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .admin-nav .btn {
            font-size: 0.9rem;
            padding: 10px 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'Poppins', sans-serif;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Evaluation Form Styles */
        .rating-group {
            margin: 20px 0;
        }

        .rating-stars {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 10px 0;
        }

        .star {
            font-size: 2rem;
            color: #d1d5db;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star.active,
        .star:hover {
            color: #fbbf24;
        }

        .textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }

        .textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-container" style="margin-bottom: 20px;">
                <img src="depuzzel_logo_groen.png" alt="De Puzzel Logo" class="header-logo" style="height: 80px; width: auto;">
            </div>
            <h1>🎃 Halloween 2025</h1>
            <p>Vrijwilligersplanning De Puzzel</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('client')">📅 Boeken</button>
            <button class="tab-btn" onclick="showTab('evaluation')">⭐ Evaluatie</button>
            <button class="tab-btn" onclick="showTab('admin')">🔧 Admin</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingMessage" class="loading">
            <h3>⏳ Bezig met laden...</h3>
            <p>Data wordt opgehaald van de server</p>
        </div>

        <!-- Client Tab - Booking Section -->
        <div id="clientTab" class="tab-content active">
            <!-- Volunteer Motivation Section -->
            <div id="motivationSection" class="priority-section">
                <h2>🌟 Waarom Vrijwilliger Worden?</h2>
                <p>Ontdek wat vrijwilligerswerk bij De Puzzel zo bijzonder maakt!</p>
                <div id="motivationReasons" class="priority-functions">
                    <div class="priority-function">
                        <h4>🏫 Bouw mee aan de school</h4>
                        <p>Help mee om De Puzzel nog beter te maken voor alle leerlingen</p>
                    </div>
                    <div class="priority-function">
                        <h4>🍺 Gratis drankkaart</h4>
                        <p>Geniet van gratis drankjes tijdens het evenement</p>
                    </div>
                    <div class="priority-function">
                        <h4>👥 Maak nieuwe vrienden</h4>
                        <p>Ontmoet andere enthousiaste vrijwilligers en bouw mooie vriendschappen</p>
                    </div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>🗓️ Halloween Planning Rooster</h3>
                </div>

                <!-- Function Filter -->
                <div style="margin-bottom: 20px;">
                    <label for="functionFilter" class="form-label">Filter op functie:</label>
                    <select id="functionFilter" class="form-input" onchange="filterByFunction(this.value)">
                        <option value="all">Alle functies</option>
                    </select>
                </div>

                <!-- Schedule Content -->
                <div id="scheduleContent"></div>
            </div>
        </div>

        <!-- Evaluation Tab -->
        <div id="evaluationTab" class="tab-content">
            <div class="card">
                <h2>⭐ Halloween 2025 Evaluatie</h2>
                <p>Vanaf 18 oktober kun je hier je ervaringen delen als vrijwilliger.</p>
                
                <div id="evaluationForm" style="display: none;">
                    <form id="evalForm">
                        <div class="form-group">
                            <label class="form-label">Je naam (optioneel):</label>
                            <input type="text" id="evalName" class="form-input" placeholder="Naam">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Voor welke functie was je vrijwilliger?</label>
                            <select id="evalFunction" class="form-input" required></select>
                        </div>

                        <div class="rating-group">
                            <label class="form-label">Hoe beoordeel je de organisatie? (1-5 sterren)</label>
                            <div class="rating-stars" id="organizationRating">
                                <span class="star" data-rating="1">⭐</span>
                                <span class="star" data-rating="2">⭐</span>
                                <span class="star" data-rating="3">⭐</span>
                                <span class="star" data-rating="4">⭐</span>
                                <span class="star" data-rating="5">⭐</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Wat ging er goed?</label>
                            <textarea id="evalPositive" class="textarea" placeholder="Positieve punten..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Wat kan er beter?</label>
                            <textarea id="evalImprovements" class="textarea" placeholder="Verbeterpunten..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Wil je volgend jaar weer vrijwilliger zijn?</label>
                            <select id="evalVolunteerAgain" class="form-input" required>
                                <option value="">Maak een keuze...</option>
                                <option value="yes">Ja, zeker!</option>
                                <option value="maybe">Misschien</option>
                                <option value="no">Nee</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Overige opmerkingen:</label>
                            <textarea id="evalComments" class="textarea" placeholder="Opmerkingen..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">📝 Evaluatie Versturen</button>
                    </form>
                </div>

                <div id="evaluationClosed" style="text-align: center; padding: 40px;">
                    <h3>📅 Evaluatie nog niet beschikbaar</h3>
                    <p>Je kunt de evaluatie invullen vanaf 18 oktober 2025, na het Halloween evenement.</p>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content">
            <!-- Admin Login -->
            <div id="adminLogin" class="card">
                <h2>🔐 Admin Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Wachtwoord:</label>
                        <input type="password" id="adminPassword" class="form-input" placeholder="Voer admin wachtwoord in" required>
                    </div>
                    <button type="submit" class="btn btn-primary">🔓 Inloggen</button>
                </form>
            </div>

            <!-- Admin Panel -->
            <div id="adminPanel" style="display: none;">
                <!-- Admin Navigation -->
                <div class="admin-nav">
                    <button class="btn btn-primary" onclick="showAdminSection('overview')">📊 Overzicht</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('bookings')">👥 Boekingen</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('functions')">🎯 Functies</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('timeslots')">⏰ Tijdsloten</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('evaluations')">⭐ Evaluaties</button>
                    <button class="btn btn-secondary" onclick="showAdminSection('settings')">⚙️ Instellingen</button>
                </div>

                <!-- Admin Content -->
                <div id="adminContent"></div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📝 Tijdslot Boeken</h3>
                <div id="bookingSlotInfo"></div>
            </div>
            <form id="bookingForm">
                <div class="form-group">
                    <label class="form-label">Naam *</label>
                    <input type="text" id="bookingName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">E-mail *</label>
                    <input type="email" id="bookingEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefoon (optioneel)</label>
                    <input type="tel" id="bookingPhone" class="form-input">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">✅ Bevestigen</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bookingModal')" style="flex: 1;">❌ Annuleren</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div style="font-size: 3rem; margin-bottom: 15px;">🎉</div>
                <h3>Boeking Gelukt!</h3>
            </div>
            <div id="successContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn btn-primary" onclick="closeModal('successModal')" style="flex: 1;">👍 Perfect!</button>
            </div>
        </div>
    </div>

    <!-- Function Modal -->
    <div id="functionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="functionModalTitle">➕ Nieuwe Functie Toevoegen</h3>
            </div>
            <form id="functionForm">
                <div class="form-group">
                    <label class="form-label">Functie Naam *</label>
                    <input type="text" id="functionName" class="form-input" required placeholder="bijv. Horror House">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschrijving *</label>
                    <textarea id="functionDescription" class="textarea" required placeholder="Korte beschrijving van de functie en taken..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Kleur Selectie</label>
                    <div id="colorPicker" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px;"></div>
                    <input type="hidden" id="functionColorIndex" value="0">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">✓ Opslaan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('functionModal')" style="flex: 1;">❌ Annuleren</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timeslot Modal -->
    <div id="timeslotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="timeslotModalTitle">➕ Nieuw Tijdslot Toevoegen</h3>
            </div>
            <form id="timeslotForm">
                <div class="form-group">
                    <label class="form-label">Functie *</label>
                    <select id="timeslotFunction" class="form-input" required>
                        <option value="">Kies een functie...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Datum *</label>
                    <input type="date" id="timeslotDate" class="form-input" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Start Tijd *</label>
                        <input type="time" id="timeslotStartTime" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eind Tijd *</label>
                        <input type="time" id="timeslotEndTime" class="form-input" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Capaciteit (aantal vrijwilligers) *</label>
                    <input type="number" id="timeslotCapacity" class="form-input" required min="1" max="20" placeholder="bijv. 3">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">✓ Opslaan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('timeslotModal')" style="flex: 1;">❌ Annuleren</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global Variables
        let functions = [];
        let timeSlots = [];
        let bookings = [];
        let evaluations = [];
        let currentView = 'calendar';
        let selectedFunction = 'all';
        let currentBookingSlot = null;
        let isAdminLoggedIn = false;

        // Email Configuration
        const EMAILJS_CONFIG = {
            serviceId: 'service_halloween2025',
            templateId: 'template_volunteer',
            publicKey: 'VehBeO9qQGs5Tbvvn'
        };

        // Initialize EmailJS
        emailjs.init(EMAILJS_CONFIG.publicKey);

        // Enhanced color scheme for functions - more distinct and vibrant with higher opacity
        const functionColors = [
            { primary: '#16a34a', bg: 'rgba(22, 163, 74, 0.25)', gradient: 'linear-gradient(135deg, #16a34a, #22c55e)', name: 'Groen' }, // Horror/Scare
            { primary: '#dc2626', bg: 'rgba(220, 38, 38, 0.25)', gradient: 'linear-gradient(135deg, #dc2626, #ef4444)', name: 'Rood' }, // Urgent/Emergency
            { primary: '#7c3aed', bg: 'rgba(124, 58, 237, 0.25)', gradient: 'linear-gradient(135deg, #7c3aed, #8b5cf6)', name: 'Paars' }, // Management
            { primary: '#ea580c', bg: 'rgba(234, 88, 12, 0.25)', gradient: 'linear-gradient(135deg, #ea580c, #f97316)', name: 'Oranje' }, // Service
            { primary: '#0891b2', bg: 'rgba(8, 145, 178, 0.25)', gradient: 'linear-gradient(135deg, #0891b2, #06b6d4)', name: 'Cyaan' }, // Support
            { primary: '#059669', bg: 'rgba(5, 150, 105, 0.25)', gradient: 'linear-gradient(135deg, #059669, #10b981)', name: 'Smaragd' }, // Cleanup
            { primary: '#be185d', bg: 'rgba(190, 24, 93, 0.25)', gradient: 'linear-gradient(135deg, #be185d, #ec4899)', name: 'Roze' }, // Special
            { primary: '#1e40af', bg: 'rgba(30, 64, 175, 0.25)', gradient: 'linear-gradient(135deg, #1e40af, #3b82f6)', name: 'Blauw' }, // Tech
            { primary: '#92400e', bg: 'rgba(146, 64, 14, 0.25)', gradient: 'linear-gradient(135deg, #92400e, #d97706)', name: 'Bruin' }, // Setup
            { primary: '#7e22ce', bg: 'rgba(126, 34, 206, 0.25)', gradient: 'linear-gradient(135deg, #7e22ce, #a855f7)', name: 'Violet' } // Creative
        ];

        // Utility Functions
        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success-message';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showLoading(show = true) {
            const loading = document.getElementById('loadingMessage');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        function getFunctionColor(index) {
            return functionColors[index % functionColors.length];
        }

        function getFunctionColorById(functionId) {
            const func = functions.find(f => f.id === functionId);
            if (func && func.colorIndex !== undefined) {
                return getFunctionColor(func.colorIndex);
            }
            // Fallback to index-based coloring for legacy functions
            const index = functions.findIndex(f => f.id === functionId);
            return getFunctionColor(index);
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('nl-NL', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Hide all tab buttons active state
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Special handling for evaluation tab
            if (tabName === 'evaluation') {
                checkEvaluationAvailability();
            }
        }

        // Modal Management - improved event handling
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            
            // Ensure modal content clicks don't bubble
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'bookingModal') {
                document.getElementById('bookingForm').reset();
                currentBookingSlot = null;
            }
            if (modalId === 'functionModal') {
                document.getElementById('functionForm').reset();
                currentEditingFunction = null;
            }
            if (modalId === 'timeslotModal') {
                document.getElementById('timeslotForm').reset();
                currentEditingTimeslot = null;
            }
        }

        // Initialize App
        window.initializeApp = async function() {
            console.log('🚀 Initializing Halloween 2025 Volunteer Planning App...');
            
            try {
                showLoading(true);
                
                // Load data from Firebase
                await loadDataFromFirebase();
                
                // Initialize UI
                initializeUI();
                
                // Generate sample data if empty
                if (functions.length === 0 || timeSlots.length === 0) {
                    await generateHalloweenData();
                }
                
                // Setup event listeners
                setupEventListeners();
                
                showLoading(false);
                console.log('✅ App initialized successfully!');
                
            } catch (error) {
                console.error('❌ Error initializing app:', error);
                showError('Fout bij het laden van de applicatie');
                showLoading(false);
                
                // Fallback to sample data
                generateHalloweenData();
                initializeUI();
                setupEventListeners();
            }
        };

        // Load Data from Firebase
        async function loadDataFromFirebase() {
            console.log('📊 Loading data from Firebase...');
            
            try {
                // Load functions
                const functionsSnapshot = await window.getDocs(window.collection(window.db, 'functions'));
                functions = functionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load time slots
                const timeSlotsSnapshot = await window.getDocs(window.collection(window.db, 'timeSlots'));
                timeSlots = timeSlotsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load bookings
                const bookingsSnapshot = await window.getDocs(window.collection(window.db, 'bookings'));
                bookings = bookingsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load evaluations
                const evaluationsSnapshot = await window.getDocs(window.collection(window.db, 'evaluations'));
                evaluations = evaluationsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log('✅ Data loaded:', { functions: functions.length, timeSlots: timeSlots.length, bookings: bookings.length, evaluations: evaluations.length });
                
                // Ensure all functions have colorIndex for legacy compatibility
                functions.forEach((func, index) => {
                    if (func.colorIndex === undefined) {
                        func.colorIndex = index % functionColors.length;
                    }
                });
                
            } catch (error) {
                console.error('❌ Error loading data from Firebase:', error);
                throw error;
            }
        }

        // Generate Halloween Sample Data
        async function generateHalloweenData() {
            console.log('🎃 Generating Halloween 2025 sample data...');
            
            // Halloween Functions with colorIndex
            const halloweenFunctions = [
                {
                    id: 'horror-house',
                    name: 'Horror House',
                    description: 'Bezoekers door het griezelige horror huis begeleiden en voor sfeer zorgen',
                    colorIndex: 0
                },
                {
                    id: 'scare-actors',
                    name: 'Scare Actors',
                    description: 'Bezoekers laten schrikken in verschillende themadecors',
                    colorIndex: 1
                },
                {
                    id: 'ticket-verkoop',
                    name: 'Ticket Verkoop',
                    description: 'Tickets verkopen en bezoekers verwelkomen bij de ingang',
                    colorIndex: 2
                },
                {
                    id: 'catering',
                    name: 'Catering',
                    description: 'Drankjes en snacks verkopen aan bezoekers',
                    colorIndex: 3
                },
                {
                    id: 'decoratie',
                    name: 'Decoratie',
                    description: 'Halloween decoraties ophangen en sfeer creëren',
                    colorIndex: 4
                },
                {
                    id: 'opruimen',
                    name: 'Opruimen',
                    description: 'Na het evenement alles netjes opruimen en inpakken',
                    colorIndex: 5
                }
            ];

            // Halloween Time Slots
            const halloweenTimeSlots = [
                // Voorbereiding - 16 oktober
                { functionId: 'decoratie', date: '2025-10-16', startTime: '14:00', endTime: '17:00', capacity: 4 },
                { functionId: 'decoratie', date: '2025-10-16', startTime: '17:00', endTime: '20:00', capacity: 3 },
                
                // Halloween Day - 17 oktober
                { functionId: 'ticket-verkoop', date: '2025-10-17', startTime: '18:00', endTime: '20:00', capacity: 2 },
                { functionId: 'ticket-verkoop', date: '2025-10-17', startTime: '20:00', endTime: '22:00', capacity: 2 },
                { functionId: 'horror-house', date: '2025-10-17', startTime: '18:30', endTime: '20:30', capacity: 3 },
                { functionId: 'horror-house', date: '2025-10-17', startTime: '20:30', endTime: '22:30', capacity: 3 },
                { functionId: 'scare-actors', date: '2025-10-17', startTime: '18:30', endTime: '20:30', capacity: 5 },
                { functionId: 'scare-actors', date: '2025-10-17', startTime: '20:30', endTime: '22:30', capacity: 5 },
                { functionId: 'catering', date: '2025-10-17', startTime: '18:00', endTime: '21:00', capacity: 3 },
                { functionId: 'catering', date: '2025-10-17', startTime: '21:00', endTime: '23:00', capacity: 2 },
                
                // Opruiming - 18 oktober
                { functionId: 'opruimen', date: '2025-10-18', startTime: '10:00', endTime: '13:00', capacity: 6 },
                { functionId: 'opruimen', date: '2025-10-18', startTime: '13:00', endTime: '16:00', capacity: 4 }
            ];

            try {
                // Save functions to Firebase
                for (const func of halloweenFunctions) {
                    await window.addDoc(window.collection(window.db, 'functions'), func);
                }

                // Save time slots to Firebase
                for (const slot of halloweenTimeSlots) {
                    const slotData = {
                        ...slot,
                        id: generateId(),
                        booked: Math.floor(Math.random() * (slot.capacity / 2)), // Random bookings
                        volunteers: []
                    };
                    await window.addDoc(window.collection(window.db, 'timeSlots'), slotData);
                }

                // Reload data from Firebase
                await loadDataFromFirebase();

                console.log('✅ Halloween sample data generated successfully!');
                showSuccess('🎃 Halloween planning data geladen!');

            } catch (error) {
                console.error('❌ Error generating sample data:', error);
                
                // Fallback to local data if Firebase fails
                functions = halloweenFunctions;
                timeSlots = halloweenTimeSlots.map(slot => ({
                    ...slot,
                    id: generateId(),
                    booked: Math.floor(Math.random() * (slot.capacity / 2)),
                    volunteers: []
                }));
                
                // Ensure all functions have colorIndex for fallback
                functions.forEach((func, index) => {
                    if (func.colorIndex === undefined) {
                        func.colorIndex = index % functionColors.length;
                    }
                });
                
                showError('Firebase niet beschikbaar - lokale data geladen');
            }
        }

        // Initialize UI
        function initializeUI() {
            console.log('🎨 Initializing UI...');
            
            // Populate function filter
            const functionFilter = document.getElementById('functionFilter');
            functionFilter.innerHTML = '<option value="all">Alle functies</option>';
            functions.forEach(func => {
                const option = document.createElement('option');
                option.value = func.id;
                option.textContent = func.name;
                functionFilter.appendChild(option);
            });

            // Populate evaluation function dropdown
            const evalFunction = document.getElementById('evalFunction');
            evalFunction.innerHTML = '<option value="">Kies een functie...</option>';
            functions.forEach(func => {
                const option = document.createElement('option');
                option.value = func.id;
                option.textContent = func.name;
                evalFunction.appendChild(option);
            });

            // Render initial view
            renderSchedule();
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Booking form
            document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);
            
            // Evaluation form
            document.getElementById('evalForm').addEventListener('submit', handleEvaluationSubmit);
            
            // Rating stars
            setupRatingStars();
            
            // Admin login
            document.getElementById('loginForm').addEventListener('submit', handleAdminLogin);
            
            // Function form
            document.getElementById('functionForm').addEventListener('submit', handleFunctionSubmit);
            
            // Timeslot form
            document.getElementById('timeslotForm').addEventListener('submit', handleTimeslotSubmit);
            
            // Modal close on outside click - prevent event bubbling issues
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
                
                // Prevent modal content clicks from bubbling to modal wrapper
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
            });
        }

        // View Management - removed toggle, only calendar view

        function filterByFunction(functionId) {
            selectedFunction = functionId;
            renderSchedule();
        }

        // Schedule Rendering - only calendar view
        function renderSchedule() {
            const content = document.getElementById('scheduleContent');
            renderCalendarSchedule(content);
        }

        // Overview function removed - only calendar view now

        function renderCalendarSchedule(container) {
            // Similar to overview but more compact, time-focused layout
            const slotsByDate = {};
            timeSlots.forEach(slot => {
                if (selectedFunction !== 'all' && slot.functionId !== selectedFunction) return;
                
                if (!slotsByDate[slot.date]) {
                    slotsByDate[slot.date] = [];
                }
                slotsByDate[slot.date].push(slot);
            });

            let html = '<div style="display: grid; gap: 25px;">';
            
            Object.keys(slotsByDate).sort().forEach(date => {
                const dateSlots = slotsByDate[date];
                
                html += `
                    <div class="card" style="padding: 20px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">${formatDate(date)}</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                `;
                
                dateSlots.sort((a, b) => a.startTime.localeCompare(b.startTime)).forEach(slot => {
                    const func = functions.find(f => f.id === slot.functionId);
                    const color = getFunctionColorById(slot.functionId);
                    const available = slot.capacity - slot.booked;
                    const isAvailable = available > 0;
                    
                    html += `
                    <div class="timeslot ${isAvailable ? 'available' : 'full'}" 
                    style="padding: 15px; border: 3px solid ${color.primary}; background: ${color.bg}; position: relative; overflow: hidden;"
                    ${isAvailable ? `data-slot-id="${slot.id}"` : ''}>
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: ${color.gradient}; opacity: 0.15; z-index: 1;"></div>
                    <div style="position: relative; z-index: 2;">
                        <div style="font-weight: 700; color: ${color.primary}; margin-bottom: 8px; font-size: 1rem;">${func.name}</div>
                        <div style="font-size: 0.9rem; margin-bottom: 8px; font-weight: 600;">${slot.startTime} - ${slot.endTime}</div>
                        <div style="font-size: 0.8rem; color: #374151; font-weight: 500;">
                        ${isAvailable ? `${available} van ${slot.capacity} vrij` : `Vol (${slot.capacity} plekken)`}
                        </div>
                    </div>
                    </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Add event listeners for timeslot clicks
            document.querySelectorAll('[data-slot-id]').forEach(slot => {
                slot.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const slotId = this.getAttribute('data-slot-id');
                    if (slotId) {
                        openBookingModal(slotId);
                    }
                });
            });
        }

        // Motivation section is now static in HTML

        // Booking Modal
        function openBookingModal(slotId) {
            const slot = timeSlots.find(s => s.id === slotId);
            if (!slot) return;

            const func = functions.find(f => f.id === slot.functionId);
            const color = getFunctionColorById(slot.functionId);
            
            currentBookingSlot = slot;
            
            const slotInfo = document.getElementById('bookingSlotInfo');
            slotInfo.innerHTML = `
                <div style="background: ${color.gradient}; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 8px;">${func.name}</h4>
                    <p style="margin-bottom: 8px; font-size: 0.9rem;">${func.description}</p>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                        <span>📅 ${formatDate(slot.date)}</span>
                        <span>🕐 ${slot.startTime} - ${slot.endTime}</span>
                    </div>
                </div>
            `;
            
            openModal('bookingModal');
        }

        // Handle Booking Submit
        async function handleBookingSubmit(e) {
            e.preventDefault();
            
            if (!currentBookingSlot) return;
            
            const formData = {
                name: document.getElementById('bookingName').value,
                email: document.getElementById('bookingEmail').value,
                phone: document.getElementById('bookingPhone').value || null,
                slotId: currentBookingSlot.id,
                functionId: currentBookingSlot.functionId,
                date: currentBookingSlot.date,
                startTime: currentBookingSlot.startTime,
                endTime: currentBookingSlot.endTime,
                bookingDate: new Date().toISOString()
            };

            try {
                // Save booking to Firebase
                await window.addDoc(window.collection(window.db, 'bookings'), formData);
                
                // Update time slot
                const slotRef = window.doc(window.db, 'timeSlots', currentBookingSlot.id);
                await window.updateDoc(slotRef, {
                    booked: currentBookingSlot.booked + 1,
                    volunteers: [...(currentBookingSlot.volunteers || []), {
                        name: formData.name,
                        email: formData.email,
                        phone: formData.phone
                    }]
                });

                // Send confirmation email
                await sendConfirmationEmail(formData);
                
                // Update local data
                currentBookingSlot.booked += 1;
                if (!currentBookingSlot.volunteers) currentBookingSlot.volunteers = [];
                currentBookingSlot.volunteers.push({
                    name: formData.name,
                    email: formData.email,
                    phone: formData.phone
                });
                bookings.push(formData);

                closeModal('bookingModal');
                showBookingSuccess(formData);
                renderSchedule();
                
            } catch (error) {
                console.error('❌ Error saving booking:', error);
                showError('Fout bij het opslaan van de boeking');
            }
        }

        function showBookingSuccess(booking) {
            const func = functions.find(f => f.id === booking.functionId);
            const successContent = document.getElementById('successContent');
            
            successContent.innerHTML = `
                <div style="text-align: center; margin: 20px 0;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Je bent ingeschreven voor:</h4>
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color);">
                        <p><strong>Functie:</strong> ${func.name}</p>
                        <p><strong>Datum:</strong> ${formatDate(booking.date)}</p>
                        <p><strong>Tijd:</strong> ${booking.startTime} - ${booking.endTime}</p>
                        <p><strong>Naam:</strong> ${booking.name}</p>
                    </div>
                    <p style="color: #6b7280; margin-top: 15px; font-size: 0.9rem;">
                        Je ontvangt een bevestigingsmail met alle details!
                    </p>
                </div>
            `;
            
            openModal('successModal');
        }

        // Email Functionality
        async function sendConfirmationEmail(booking) {
            const func = functions.find(f => f.id === booking.functionId);
            
            const templateParams = {
                to_name: booking.name,
                to_email: booking.email,
                function_name: func.name,
                function_description: func.description,
                date: formatDate(booking.date),
                start_time: booking.startTime,
                end_time: booking.endTime,
                phone: booking.phone || 'Niet opgegeven'
            };

            try {
                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams,
                    EMAILJS_CONFIG.publicKey
                );
                console.log('✅ Confirmation email sent');
            } catch (error) {
                console.error('❌ Error sending email:', error);
            }
        }

        // Evaluation Section
        function checkEvaluationAvailability() {
            const today = new Date();
            const evaluationDate = new Date('2025-10-18');
            
            if (today >= evaluationDate) {
                document.getElementById('evaluationForm').style.display = 'block';
                document.getElementById('evaluationClosed').style.display = 'none';
            } else {
                document.getElementById('evaluationForm').style.display = 'none';
                document.getElementById('evaluationClosed').style.display = 'block';
            }
        }

        function setupRatingStars() {
            const stars = document.querySelectorAll('#organizationRating .star');
            let selectedRating = 0;

            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    selectedRating = index + 1;
                    updateStars(selectedRating);
                });

                star.addEventListener('mouseover', () => {
                    updateStars(index + 1);
                });
            });

            document.getElementById('organizationRating').addEventListener('mouseleave', () => {
                updateStars(selectedRating);
            });

            function updateStars(rating) {
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
                document.getElementById('organizationRating').dataset.rating = rating;
            }
        }

        async function handleEvaluationSubmit(e) {
            e.preventDefault();
            
            const rating = document.getElementById('organizationRating').dataset.rating;
            if (!rating || rating < 1) {
                showError('Geef een beoordeling van 1-5 sterren');
                return;
            }

            const evaluation = {
                name: document.getElementById('evalName').value || null,
                functionId: document.getElementById('evalFunction').value,
                organizationRating: parseInt(rating),
                positive: document.getElementById('evalPositive').value || null,
                improvements: document.getElementById('evalImprovements').value || null,
                volunteerAgain: document.getElementById('evalVolunteerAgain').value,
                comments: document.getElementById('evalComments').value || null,
                submittedDate: new Date().toLocaleDateString('nl-NL')
            };

            try {
                await window.addDoc(window.collection(window.db, 'evaluations'), evaluation);
                evaluations.push(evaluation);
                
                document.getElementById('evalForm').reset();
                document.getElementById('organizationRating').dataset.rating = '0';
                document.querySelectorAll('#organizationRating .star').forEach(star => {
                    star.classList.remove('active');
                });
                
                showSuccess('🌟 Bedankt voor je evaluatie!');
                
            } catch (error) {
                console.error('❌ Error saving evaluation:', error);
                showError('Fout bij het opslaan van de evaluatie');
            }
        }

        // Function Management
        let currentEditingFunction = null;
        
        // Timeslot Management
        let currentEditingTimeslot = null;
        
        function openAddTimeslotModal() {
            currentEditingTimeslot = null;
            document.getElementById('timeslotModalTitle').textContent = '➕ Nieuw Tijdslot Toevoegen';
            document.getElementById('timeslotForm').reset();
            
            // Populate function dropdown
            const functionSelect = document.getElementById('timeslotFunction');
            functionSelect.innerHTML = '<option value="">Kies een functie...</option>';
            functions.forEach(func => {
                const option = document.createElement('option');
                option.value = func.id;
                option.textContent = func.name;
                functionSelect.appendChild(option);
            });
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('timeslotDate').value = today;
            
            openModal('timeslotModal');
        }
        
        function editTimeslot(timeslotId) {
            const slot = timeSlots.find(s => s.id === timeslotId);
            if (!slot) return;
            
            currentEditingTimeslot = slot;
            document.getElementById('timeslotModalTitle').textContent = '✏️ Tijdslot Bewerken';
            
            // Populate function dropdown
            const functionSelect = document.getElementById('timeslotFunction');
            functionSelect.innerHTML = '<option value="">Kies een functie...</option>';
            functions.forEach(func => {
                const option = document.createElement('option');
                option.value = func.id;
                option.textContent = func.name;
                option.selected = func.id === slot.functionId;
                functionSelect.appendChild(option);
            });
            
            // Fill form with current values
            document.getElementById('timeslotFunction').value = slot.functionId;
            document.getElementById('timeslotDate').value = slot.date;
            document.getElementById('timeslotStartTime').value = slot.startTime;
            document.getElementById('timeslotEndTime').value = slot.endTime;
            document.getElementById('timeslotCapacity').value = slot.capacity;
            
            openModal('timeslotModal');
        }
        
        async function deleteTimeslot(timeslotId) {
            const slot = timeSlots.find(s => s.id === timeslotId);
            if (!slot) return;
            
            const func = functions.find(f => f.id === slot.functionId);
            const funcName = func ? func.name : 'Onbekende functie';
            
            // Check if timeslot has bookings
            const slotBookings = bookings.filter(booking => booking.slotId === timeslotId);
            
            if (slotBookings.length > 0) {
                showError(`Kan tijdslot niet verwijderen omdat er nog ${slotBookings.length} boeking(en) aan gekoppeld zijn.`);
                return;
            }
            
            if (!confirm(`Weet je zeker dat je het tijdslot "${funcName} op ${formatDate(slot.date)} van ${slot.startTime}-${slot.endTime}" wilt verwijderen?`)) {
                return;
            }
            
            try {
                // Delete from Firebase
                if (slot.firebaseId) {
                    await window.deleteDoc(window.doc(window.db, 'timeSlots', slot.firebaseId));
                }
                
                // Remove from local array
                timeSlots = timeSlots.filter(s => s.id !== timeslotId);
                
                showSuccess('Tijdslot succesvol verwijderd');
                
                // Refresh UI
                initializeUI();
                showAdminSection('timeslots');
                
            } catch (error) {
                console.error('Error deleting timeslot:', error);
                showError('Fout bij het verwijderen van het tijdslot');
            }
        }
        
        async function handleTimeslotSubmit(e) {
            e.preventDefault();
            
            const functionId = document.getElementById('timeslotFunction').value;
            const date = document.getElementById('timeslotDate').value;
            const startTime = document.getElementById('timeslotStartTime').value;
            const endTime = document.getElementById('timeslotEndTime').value;
            const capacity = parseInt(document.getElementById('timeslotCapacity').value);
            
            if (!functionId || !date || !startTime || !endTime || !capacity) {
                showError('Vul alle verplichte velden in');
                return;
            }
            
            // Validate time
            if (startTime >= endTime) {
                showError('Start tijd moet voor eind tijd liggen');
                return;
            }
            
            // Check for overlapping timeslots for the same function on the same date
            const overlappingSlots = timeSlots.filter(slot => {
                if (currentEditingTimeslot && slot.id === currentEditingTimeslot.id) {
                    return false; // Skip current slot when editing
                }
                return slot.functionId === functionId && 
                       slot.date === date && 
                       ((startTime >= slot.startTime && startTime < slot.endTime) ||
                        (endTime > slot.startTime && endTime <= slot.endTime) ||
                        (startTime <= slot.startTime && endTime >= slot.endTime));
            });
            
            if (overlappingSlots.length > 0) {
                showError('Er bestaat al een tijdslot voor deze functie dat overlapt met de gekozen tijd');
                return;
            }
            
            try {
                if (currentEditingTimeslot) {
                    // Update existing timeslot
                    const timeslotData = {
                        functionId,
                        date,
                        startTime,
                        endTime,
                        capacity
                    };
                    
                    // Update in Firebase if it has a Firebase ID
                    if (currentEditingTimeslot.firebaseId) {
                        const timeslotRef = window.doc(window.db, 'timeSlots', currentEditingTimeslot.firebaseId);
                        await window.updateDoc(timeslotRef, timeslotData);
                    }
                    
                    // Update local data
                    const index = timeSlots.findIndex(s => s.id === currentEditingTimeslot.id);
                    if (index !== -1) {
                        timeSlots[index] = { ...timeSlots[index], ...timeslotData };
                    }
                    
                    showSuccess('Tijdslot succesvol bijgewerkt');
                    
                } else {
                    // Add new timeslot
                    const timeslotData = {
                        id: generateId(),
                        functionId,
                        date,
                        startTime,
                        endTime,
                        capacity,
                        booked: 0,
                        volunteers: []
                    };
                    
                    // Save to Firebase
                    const docRef = await window.addDoc(window.collection(window.db, 'timeSlots'), timeslotData);
                    timeslotData.firebaseId = docRef.id;
                    
                    // Add to local array
                    timeSlots.push(timeslotData);
                    
                    showSuccess('Tijdslot succesvol toegevoegd');
                }
                
                // Refresh UI
                initializeUI();
                closeModal('timeslotModal');
                showAdminSection('timeslots');
                
            } catch (error) {
                console.error('Error saving timeslot:', error);
                showError('Fout bij het opslaan van het tijdslot');
            }
        }
        
        function openAddFunctionModal() {
            currentEditingFunction = null;
            document.getElementById('functionModalTitle').textContent = '➕ Nieuwe Functie Toevoegen';
            document.getElementById('functionForm').reset();
            
            // Set default color to next available color
            const defaultColorIndex = functions.length % functionColors.length;
            document.getElementById('functionColorIndex').value = defaultColorIndex;
            
            // Setup color picker with default selection
            setupColorPicker(defaultColorIndex);
            
            openModal('functionModal');
        }
        
        function selectColor(index) {
            document.getElementById('functionColorIndex').value = index;
            
            // Update visual selection
            const colorOptions = document.querySelectorAll('#colorPicker > div');
            colorOptions.forEach((option, i) => {
                option.style.border = i === index ? '3px solid #000' : '3px solid transparent';
            });
        }
        
        function setupColorPicker(selectedIndex = 0) {
            const colorPicker = document.getElementById('colorPicker');
            colorPicker.innerHTML = '';
            
            functionColors.forEach((color, index) => {
                const colorOption = document.createElement('div');
                colorOption.style.cssText = `
                    width: 40px;
                    height: 40px;
                    background: ${color.gradient};
                    border-radius: 8px;
                    cursor: pointer;
                    border: 3px solid ${index === selectedIndex ? '#000' : 'transparent'};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 0.8rem;
                    transition: all 0.3s ease;
                `;
                colorOption.textContent = color.name.substring(0, 1);
                
                // Add click event listener to prevent bubbling
                colorOption.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectColor(index);
                });
                
                colorPicker.appendChild(colorOption);
            });
        }
        
        function editFunction(functionId) {
            const func = functions.find(f => f.id === functionId);
            if (!func) return;
            
            currentEditingFunction = func;
            document.getElementById('functionModalTitle').textContent = '✏️ Functie Bewerken';
            document.getElementById('functionName').value = func.name;
            document.getElementById('functionDescription').value = func.description;
            
            // Use stored colorIndex or fallback to position-based
            let colorIndex = 0;
            if (func.colorIndex !== undefined) {
                colorIndex = func.colorIndex;
            } else {
                // Fallback for legacy functions
                const functionIndex = functions.findIndex(f => f.id === functionId);
                colorIndex = functionIndex % functionColors.length;
            }
            
            document.getElementById('functionColorIndex').value = colorIndex;
            
            // Setup color picker with current selection
            setupColorPicker(colorIndex);
            
            openModal('functionModal');
        }
        
        async function deleteFunction(functionId) {
            const func = functions.find(f => f.id === functionId);
            if (!func) return;
            
            // Check if function has any timeslots or bookings
            const funcSlots = timeSlots.filter(slot => slot.functionId === functionId);
            const funcBookings = bookings.filter(booking => booking.functionId === functionId);
            
            if (funcSlots.length > 0 || funcBookings.length > 0) {
                showError(`Kan functie "${func.name}" niet verwijderen omdat er nog tijdsloten (${funcSlots.length}) of boekingen (${funcBookings.length}) aan gekoppeld zijn.`);
                return;
            }
            
            if (!confirm(`Weet je zeker dat je de functie "${func.name}" wilt verwijderen?`)) {
                return;
            }
            
            try {
                // Delete from Firebase
                const functionDoc = functions.find(f => f.id === functionId);
                if (functionDoc.firebaseId) {
                    await window.deleteDoc(window.doc(window.db, 'functions', functionDoc.firebaseId));
                }
                
                // Remove from local array
                functions = functions.filter(f => f.id !== functionId);
                
                showSuccess(`Functie "${func.name}" succesvol verwijderd`);
                
                // Refresh UI
                initializeUI();
                showAdminSection('functions');
                
            } catch (error) {
                console.error('Error deleting function:', error);
                showError('Fout bij het verwijderen van de functie');
            }
        }
        
        async function handleFunctionSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('functionName').value.trim();
            const description = document.getElementById('functionDescription').value.trim();
            const colorIndex = parseInt(document.getElementById('functionColorIndex').value);
            
            if (!name || !description) {
                showError('Vul alle verplichte velden in');
                return;
            }
            
            // Check for duplicate names (excluding current function when editing)
            const existingFunction = functions.find(f => 
                f.name.toLowerCase() === name.toLowerCase() && 
                (!currentEditingFunction || f.id !== currentEditingFunction.id)
            );
            
            if (existingFunction) {
                showError('Er bestaat al een functie met deze naam');
                return;
            }
            
            try {
                if (currentEditingFunction) {
                    // Update existing function
                    const functionData = {
                        name,
                        description,
                        colorIndex // Include color index
                    };
                    
                    // Update in Firebase if it has a Firebase ID
                    if (currentEditingFunction.firebaseId) {
                        const functionRef = window.doc(window.db, 'functions', currentEditingFunction.firebaseId);
                        await window.updateDoc(functionRef, functionData);
                    }
                    
                    // Update local data
                    const index = functions.findIndex(f => f.id === currentEditingFunction.id);
                    if (index !== -1) {
                        functions[index] = { ...functions[index], ...functionData };
                    }
                    
                    showSuccess(`Functie "${name}" succesvol bijgewerkt`);
                    
                } else {
                    // Add new function
                    const functionData = {
                        id: generateId(),
                        name,
                        description,
                        colorIndex // Include color index
                    };
                    
                    // Save to Firebase
                    const docRef = await window.addDoc(window.collection(window.db, 'functions'), functionData);
                    functionData.firebaseId = docRef.id;
                    
                    // Add to local array
                    functions.push(functionData);
                    
                    showSuccess(`Functie "${name}" succesvol toegevoegd`);
                }
                
                // Refresh UI
                initializeUI();
                closeModal('functionModal');
                showAdminSection('functions');
                
            } catch (error) {
                console.error('Error saving function:', error);
                showError('Fout bij het opslaan van de functie');
            }
        }

        // Admin Panel
        function handleAdminLogin(e) {
            e.preventDefault();
            
            const password = document.getElementById('adminPassword').value;
            const correctPassword = 'puzzel2025'; // Simple password for demo
            
            if (password === correctPassword) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                showAdminSection('overview');
                showSuccess('🔓 Admin ingelogd');
            } else {
                showError('❌ Onjuist wachtwoord');
            }
        }

        function showAdminSection(section) {
            // Update button states
            document.querySelectorAll('.admin-nav .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            event.target.classList.remove('btn-secondary');
            event.target.classList.add('btn-primary');

            const content = document.getElementById('adminContent');
            
            switch(section) {
                case 'overview':
                    showAdminOverview(content);
                    break;
                case 'bookings':
                    showAdminBookings(content);
                    break;
                case 'functions':
                    showAdminFunctions(content);
                    break;
                case 'timeslots':
                    showAdminTimeslots(content);
                    break;
                case 'evaluations':
                    showAdminEvaluations(content);
                    break;
                case 'settings':
                    showAdminSettings(content);
                    break;
            }
        }

        function showAdminOverview(container) {
            const totalSlots = timeSlots.length;
            const totalCapacity = timeSlots.reduce((sum, slot) => sum + slot.capacity, 0);
            const totalBooked = timeSlots.reduce((sum, slot) => sum + slot.booked, 0);
            const totalAvailable = totalCapacity - totalBooked;
            const fillRate = totalCapacity > 0 ? Math.round((totalBooked / totalCapacity) * 100) : 0;

            container.innerHTML = `
                <div class="card">
                    <h2>📊 Halloween 2025 - Admin Overzicht</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${functions.length}</div>
                            <div class="stat-label">Functies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalSlots}</div>
                            <div class="stat-label">Tijdsloten</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${bookings.length}</div>
                            <div class="stat-label">Boekingen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${fillRate}%</div>
                            <div class="stat-label">Bezetting</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalAvailable}</div>
                            <div class="stat-label">Beschikbaar</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${evaluations.length}</div>
                            <div class="stat-label">Evaluaties</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3>Snelle Acties</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="exportBookingsCSV()">📊 Export Boekingen</button>
                            <button class="btn btn-primary" onclick="sendReminderEmails()">📧 Verzend Herinneringen</button>
                            <button class="btn btn-secondary" onclick="showAdminSection('functions')">🎯 Beheer Functies</button>
                            <button class="btn btn-secondary" onclick="showAdminSection('timeslots')">⏰ Beheer Tijdsloten</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAdminBookings(container) {
            let html = `
                <div class="card">
                    <h2>👥 Alle Boekingen (${bookings.length})</h2>
                    
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden;">
                            <thead>
                                <tr style="background: var(--primary-color); color: white;">
                                    <th style="padding: 12px; text-align: left;">Naam</th>
                                    <th style="padding: 12px; text-align: left;">E-mail</th>
                                    <th style="padding: 12px; text-align: left;">Telefoon</th>
                                    <th style="padding: 12px; text-align: left;">Functie</th>
                                    <th style="padding: 12px; text-align: left;">Datum</th>
                                    <th style="padding: 12px; text-align: left;">Tijd</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (bookings.length === 0) {
                html += `
                    <tr>
                        <td colspan="6" style="padding: 40px; text-align: center; color: #6b7280;">
                            Nog geen boekingen ontvangen
                        </td>
                    </tr>
                `;
            } else {
                bookings.forEach(booking => {
                    const func = functions.find(f => f.id === booking.functionId);
                    html += `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 12px; font-weight: 600;">${booking.name}</td>
                            <td style="padding: 12px;"><a href="mailto:${booking.email}" style="color: var(--primary-color);">${booking.email}</a></td>
                            <td style="padding: 12px;">${booking.phone || 'Niet opgegeven'}</td>
                            <td style="padding: 12px; color: var(--primary-color); font-weight: 500;">${func ? func.name : 'Onbekend'}</td>
                            <td style="padding: 12px;">${formatDate(booking.date)}</td>
                            <td style="padding: 12px;">${booking.startTime} - ${booking.endTime}</td>
                        </tr>
                    `;
                });
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="exportBookingsCSV()">📊 Export naar CSV</button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function showAdminFunctions(container) {
            let html = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>🎯 Functies Beheer (${functions.length})</h2>
                        <button class="btn btn-primary" onclick="openAddFunctionModal()">➕ Nieuwe Functie</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;" id="functionsGrid">
            `;
            
            functions.forEach((func, index) => {
                // Use stored colorIndex or fallback to position-based
                let colorIndex = index;
                if (func.colorIndex !== undefined) {
                    colorIndex = func.colorIndex;
                }
                const color = getFunctionColor(colorIndex);
                const funcSlots = timeSlots.filter(slot => slot.functionId === func.id);
                const totalCapacity = funcSlots.reduce((sum, slot) => sum + slot.capacity, 0);
                const totalBooked = funcSlots.reduce((sum, slot) => sum + slot.booked, 0);
                
                html += `
                    <div style="background: ${color.bg}; border-radius: 12px; padding: 20px; border: 2px solid ${color.primary}30; position: relative;" data-function-id="${func.id}">
                        <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 5px;">
                            <button class="btn function-edit-btn" style="padding: 6px 10px; font-size: 0.8rem; background: white; color: ${color.primary}; border: 1px solid ${color.primary};" data-function-id="${func.id}">✏️ Bewerk</button>
                            <button class="btn function-delete-btn" style="padding: 6px 10px; font-size: 0.8rem; background: #dc2626; color: white;" data-function-id="${func.id}">🗑️ Verwijder</button>
                        </div>
                        
                        <h4 style="color: ${color.primary}; margin-bottom: 10px; margin-right: 120px;">${func.name}</h4>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">${func.description}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: ${color.primary};">${totalCapacity}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">Capaciteit</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: #f59e0b;">${totalBooked}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">Geboekt</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: ${totalCapacity - totalBooked > 0 ? '#16a34a' : '#dc2626'};">${totalCapacity - totalBooked}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">Beschikbaar</div>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 10px;">
                            ${funcSlots.length} tijdsloten beschikbaar
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 6px; font-size: 0.8rem;">
                            <strong>Kleur:</strong> ${color.name} <span style="display: inline-block; width: 15px; height: 15px; background: ${color.primary}; border-radius: 3px; margin-left: 5px;"></span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Add event listeners after HTML is rendered
            document.querySelectorAll('.function-edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const functionId = this.getAttribute('data-function-id');
                    editFunction(functionId);
                });
            });
            
            document.querySelectorAll('.function-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const functionId = this.getAttribute('data-function-id');
                    deleteFunction(functionId);
                });
            });
        }

        function showAdminTimeslots(container) {
            const slotsByDate = {};
            timeSlots.forEach(slot => {
                if (!slotsByDate[slot.date]) {
                    slotsByDate[slot.date] = [];
                }
                slotsByDate[slot.date].push(slot);
            });

            let html = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>⏰ Tijdsloten Beheer (${timeSlots.length})</h2>
                        <button class="btn btn-primary" onclick="openAddTimeslotModal()">➕ Nieuw Tijdslot</button>
                    </div>
            `;
            
            Object.keys(slotsByDate).sort().forEach(date => {
                const dateSlots = slotsByDate[date];
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 15px;">${formatDate(date)}</h3>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background: var(--primary-color); color: white;">
                                        <th style="padding: 10px; text-align: left;">Tijd</th>
                                        <th style="padding: 10px; text-align: left;">Functie</th>
                                        <th style="padding: 10px; text-align: center;">Capaciteit</th>
                                        <th style="padding: 10px; text-align: center;">Geboekt</th>
                                        <th style="padding: 10px; text-align: center;">Beschikbaar</th>
                                        <th style="padding: 10px; text-align: center;">Acties</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                dateSlots.sort((a, b) => a.startTime.localeCompare(b.startTime)).forEach(slot => {
                    const func = functions.find(f => f.id === slot.functionId);
                    const available = slot.capacity - slot.booked;
                    const color = getFunctionColorById(slot.functionId);
                    
                    html += `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px 10px; font-weight: 600;">${slot.startTime} - ${slot.endTime}</td>
                            <td style="padding: 8px 10px;">
                                <span style="color: ${color.primary}; font-weight: 600;">${func ? func.name : 'Onbekend'}</span>
                            </td>
                            <td style="padding: 8px 10px; text-align: center; font-weight: 600;">${slot.capacity}</td>
                            <td style="padding: 8px 10px; text-align: center; color: #f59e0b; font-weight: 600;">${slot.booked}</td>
                            <td style="padding: 8px 10px; text-align: center; color: ${available > 0 ? '#16a34a' : '#dc2626'}; font-weight: 600;">${available}</td>
                            <td style="padding: 8px 10px; text-align: center;">
                                <div style="display: flex; gap: 5px; justify-content: center;">
                                    <button class="btn timeslot-edit-btn" style="padding: 4px 8px; font-size: 0.7rem; background: ${color.primary}; color: white;" data-timeslot-id="${slot.id}">✏️ Bewerk</button>
                                    <button class="btn timeslot-delete-btn" style="padding: 4px 8px; font-size: 0.7rem; background: #dc2626; color: white;" data-timeslot-id="${slot.id}">🗑️ Verwijder</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Add event listeners after HTML is rendered
            document.querySelectorAll('.timeslot-edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const timeslotId = this.getAttribute('data-timeslot-id');
                    editTimeslot(timeslotId);
                });
            });
            
            document.querySelectorAll('.timeslot-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const timeslotId = this.getAttribute('data-timeslot-id');
                    deleteTimeslot(timeslotId);
                });
            });
        }

        function showAdminEvaluations(container) {
            let html = `
                <div class="card">
                    <h2>⭐ Evaluaties Overzicht (${evaluations.length})</h2>
            `;
            
            if (evaluations.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">Nog geen evaluaties ontvangen</div>
                        <div style="font-size: 0.9rem;">Evaluaties worden beschikbaar na 18 oktober 2025</div>
                    </div>
                `;
            } else {
                const avgRating = evaluations.reduce((sum, eval) => sum + eval.organizationRating, 0) / evaluations.length;
                const volunteerAgainCount = evaluations.filter(eval => eval.volunteerAgain === 'yes').length;
                const volunteerAgainPercentage = (volunteerAgainCount / evaluations.length * 100).toFixed(1);
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div class="stat-card">
                            <div class="stat-number">${avgRating.toFixed(1)}/5</div>
                            <div class="stat-label">⭐ Gemiddelde Beoordeling</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${volunteerAgainPercentage}%</div>
                            <div class="stat-label">✅ Wil Opnieuw Vrijwilliger Zijn</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${evaluations.length}</div>
                            <div class="stat-label">📝 Totaal Evaluaties</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="exportEvaluationsReport()" style="margin-bottom: 20px;">
                        📊 Export Evaluatie Rapport
                    </button>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function showAdminSettings(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>⚙️ Instellingen</h2>
                    
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h3>🔄 Data Beheer</h3>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                                <button class="btn btn-secondary" onclick="exportAllData()">📥 Export Alle Data</button>
                                <button class="btn btn-secondary" onclick="generateSampleData()">🎲 Genereer Testdata</button>
                                <button class="btn btn-secondary" onclick="clearAllData()">🗑️ Wis Alle Data</button>
                            </div>
                        </div>
                        
                        <div>
                            <h3>📧 E-mail Instellingen</h3>
                            <p style="color: #6b7280; margin-bottom: 10px;">EmailJS configuratie voor automatische bevestigingsmails.</p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="testEmail()">📨 Test E-mail</button>
                                <button class="btn btn-secondary" onclick="sendReminderEmails()">📢 Verzend Herinneringen</button>
                            </div>
                        </div>
                        
                        <div>
                            <h3>📊 Systeem Status</h3>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <p><strong>Firebase:</strong> <span style="color: #16a34a;">✅ Verbonden</span></p>
                                <p><strong>EmailJS:</strong> <span style="color: #16a34a;">✅ Actief</span></p>
                                <p><strong>Laatste Update:</strong> ${new Date().toLocaleString('nl-NL')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Export Functions
        function exportBookingsCSV() {
            if (bookings.length === 0) {
                showError('Geen boekingen om te exporteren');
                return;
            }

            const headers = ['Naam', 'E-mail', 'Telefoon', 'Functie', 'Datum', 'Starttijd', 'Eindtijd', 'Boeking Datum'];
            const csvContent = [headers];

            bookings.forEach(booking => {
                const func = functions.find(f => f.id === booking.functionId);
                const bookingDate = new Date(booking.bookingDate).toLocaleDateString('nl-NL');

                csvContent.push([
                    booking.name || '',
                    booking.email || '',
                    booking.phone || '',
                    func ? func.name : 'Onbekend',
                    booking.date || '',
                    booking.startTime || '',
                    booking.endTime || '',
                    bookingDate
                ]);
            });

            const csvString = csvContent.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Halloween-2025-Boekingen-${new Date().toLocaleDateString('nl-NL').replace(/\//g, '-')}.csv`;
            link.click();

            showSuccess(`📊 CSV geëxporteerd met ${bookings.length} boekingen`);
        }

        function exportEvaluationsReport() {
            if (evaluations.length === 0) {
                showError('Geen evaluaties om te exporteren');
                return;
            }

            const headers = ['Naam', 'Functie', 'Beoordeling', 'Positieve Punten', 'Verbeterpunten', 'Wil Opnieuw Vrijwilliger', 'Opmerkingen', 'Datum'];
            const csvContent = [headers];

            evaluations.forEach(evaluation => {
                const func = functions.find(f => f.id === evaluation.functionId);

                csvContent.push([
                    evaluation.name || 'Anoniem',
                    func ? func.name : 'Onbekend',
                    `${evaluation.organizationRating}/5`,
                    evaluation.positive || '',
                    evaluation.improvements || '',
                    evaluation.volunteerAgain === 'yes' ? 'Ja' : evaluation.volunteerAgain === 'no' ? 'Nee' : 'Misschien',
                    evaluation.comments || '',
                    evaluation.submittedDate || ''
                ]);
            });

            const csvString = csvContent.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Halloween-2025-Evaluaties-${new Date().toLocaleDateString('nl-NL').replace(/\//g, '-')}.csv`;
            link.click();

            showSuccess(`📊 Evaluatie rapport geëxporteerd met ${evaluations.length} evaluaties`);
        }

        async function sendReminderEmails() {
            if (bookings.length === 0) {
                showError('Geen boekingen om herinneringen naar te sturen');
                return;
            }

            if (!confirm(`Wil je herinneringsmails sturen naar alle ${bookings.length} vrijwilligers?`)) {
                return;
            }

            showSuccess('📧 Herinneringen worden verstuurd...');
            
            let successCount = 0;
            for (const booking of bookings) {
                try {
                    await sendConfirmationEmail(booking);
                    successCount++;
                    await new Promise(resolve => setTimeout(resolve, 500)); // Rate limiting
                } catch (error) {
                    console.error(`Failed to send reminder to ${booking.email}:`, error);
                }
            }

            showSuccess(`✅ ${successCount} herinneringen verstuurd`);
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        console.log('🎃 Halloween 2025 Volunteer Planning System Ready!');
    </script>
</body>
</html>
